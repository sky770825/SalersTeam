<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <!-- ğŸš€ æ€§èƒ½å„ªåŒ–ï¼šæ¸›å°‘é‡æ’é‡ç¹ª -->
  <meta name="theme-color" content="#d97706" />

  <!-- ğŸš€ æ€§èƒ½å„ªåŒ–ï¼šé é€£æ¥åˆ° API -->
  <link rel="preconnect" href="https://script.google.com" crossorigin />
  <link rel="dns-prefetch" href="https://script.google.com" />
  <link rel="preconnect" href="https://images.unsplash.com" crossorigin />
  <link rel="dns-prefetch" href="https://images.unsplash.com" />
  
  <title>å…­è’œåŒ…Â·é¤è»Šè¨‚è³¼è¡¨å–®ï½œç·šä¸Šé è¨‚</title>
  
  <!-- ğŸš€ æ€§èƒ½å„ªåŒ–ï¼šæ¸›å°‘ç”Ÿç”¢ç’°å¢ƒçš„ console è¼¸å‡º -->
  <script>
    // é–‹ç™¼æ¨¡å¼æ¨™èªŒï¼ˆå¯åœ¨éƒ¨ç½²æ™‚è¨­ç‚º falseï¼‰
    window.DEBUG_MODE = false; // è¨­ç‚º false å¯æ¸›å°‘ console è¼¸å‡º
    if (!window.DEBUG_MODE) {
      // åŒ…è£ console æ–¹æ³•ï¼Œåœ¨ç”Ÿç”¢ç’°å¢ƒæ¸›å°‘è¼¸å‡º
      const originalLog = console.log;
      const originalWarn = console.warn;
      console.log = function(...args) {
        // åªä¿ç•™é‡è¦çš„æ—¥èªŒ
        if (args[0] && typeof args[0] === 'string' && (
          args[0].includes('éŒ¯èª¤') || 
          args[0].includes('å¤±æ•—') || 
          args[0].includes('âŒ') ||
          args[0].includes('âš ï¸')
        )) {
          originalLog.apply(console, args);
        }
      };
      console.warn = function(...args) {
        // è­¦å‘Šä»ç„¶é¡¯ç¤º
        originalWarn.apply(console, args);
      };
    }
  </script>
  <style>
    :root{
      --bg: linear-gradient(135deg, #fef9f3 0%, #faf5ed 100%);
      --card:#ffffff;
      --text:#1a1a1a;
      --primary:#d97706;
      --primary-dark:#b45309;
      --accent:#f59e0b;
      --success:#059669;
      --danger:#dc2626;
      --muted:#6b7280;
      --border:#e5e7eb;
      --shadow: 0 4px 20px rgba(0,0,0,.06);
      --shadow-lg: 0 10px 40px rgba(0,0,0,.12);
      --radius: clamp(10px, 2vw, 16px);
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
    body{
      margin:0; 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #fef9f3;
      background: var(--bg);
      color:var(--text); 
      line-height:1.6;
      font-size: clamp(15px, 3.5vw, 16px);
      letter-spacing: 0.3px;
      padding-bottom: 20px;
    }
    
    /* Header å“ç‰Œå€ */
    .brand-header{
      background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%);
      color:#fff;
      padding: clamp(12px, 3vw, 18px) clamp(12px, 3vw, 16px);
      text-align:center;
      box-shadow: 0 4px 16px rgba(217,119,6,.25);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .brand-logo-wrap{
      display:flex;
      align-items:center;
      justify-content:center;
      gap: clamp(8px, 2vw, 12px);
      margin-bottom: 4px;
    }
    .brand-logo{
      width: clamp(40px, 10vw, 56px);
      height: clamp(40px, 10vw, 56px);
      border-radius: 50%;
      background: #fff;
      padding: 6px;
      cursor: pointer;
      transition: transform .2s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,.15);
    }
    .brand-logo:hover{ transform: scale(1.05); }
    .brand-logo:active{ transform: scale(0.98); }
    .brand-title{
      font-size: clamp(20px, 4.5vw, 24px);
      font-weight: 800;
      margin:0;
      letter-spacing: 0.5px;
    }
    .brand-subtitle{
      font-size: clamp(12px, 2.5vw, 13px);
      opacity:.9;
      margin: 2px 0 0;
      font-weight: 400;
    }
    
    /* å®¹å™¨ */
    .container{
      max-width: 1200px;
      margin: 0 auto;
      padding: clamp(12px, 3vw, 16px);
    }
    
    /* å¡ç‰‡ */
    .card{
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: clamp(14px, 3.5vw, 18px);
      margin-bottom: clamp(12px, 3vw, 16px);
    }
    
    /* å€å¡Šæ¨™é¡Œ */
    .section-title{
      font-size: clamp(17px, 4.2vw, 19px);
      font-weight: 700;
      margin: 0 0 clamp(12px, 3vw, 14px);
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 8px;
      letter-spacing: 0.5px;
      line-height: 1.4;
    }
    .section-title::before{
      content: '';
      width: 4px;
      height: clamp(17px, 4vw, 20px);
      background: var(--primary);
      border-radius: 2px;
    }
    
    /* è¡¨å–®æ¬„ä½ */
    .form-group{
      margin-bottom: clamp(12px, 3vw, 14px);
    }
    .form-label{
      display: block;
      font-weight: 600;
      margin-bottom: clamp(6px, 1.5vw, 7px);
      font-size: clamp(14px, 3.2vw, 15px);
      color: var(--text);
      letter-spacing: 0.3px;
      line-height: 1.5;
    }
    .form-label .required{ color: var(--danger); margin-left: 2px; }
    
    input, select, textarea{
      width: 100%;
      padding: clamp(10px, 2.5vw, 12px) clamp(12px, 3vw, 14px);
      border: 1.5px solid var(--border);
      border-radius: clamp(8px, 2vw, 10px);
      background: #fff;
      font-size: clamp(15px, 3.5vw, 16px);
      font-family: inherit;
      transition: all .2s ease;
      color: var(--text);
      letter-spacing: 0.3px;
      line-height: 1.5;
    }
    input:focus, select:focus, textarea:focus{
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(217,119,6,.12);
    }
    textarea{ min-height: clamp(70px, 18vw, 90px); resize: vertical; }
    
    /* å•†å“ç¶²æ ¼ - å¤šæ¬„éŸ¿æ‡‰å¼ */
    .product-grid{
      display: grid;
      grid-template-columns: repeat(2, 1fr); /* æ‰‹æ©Ÿé è¨­ 2 æ¬„ */
      gap: clamp(10px, 2.5vw, 12px);
    }
    @media(min-width: 600px){
      .product-grid{ grid-template-columns: repeat(3, 1fr); } /* å¹³æ¿ 3 æ¬„ */
    }
    @media(min-width: 900px){
      .product-grid{ grid-template-columns: repeat(4, 1fr); } /* é›»è…¦ 4 æ¬„ */
    }
    
    /* å–®é»é…èœ - åˆ†é¡å®¹å™¨ */
    .side-list{
      display: grid;
      grid-template-columns: repeat(2, 1fr); /* æ‰‹æ©Ÿ 2 æ¬„ */
      gap: clamp(8px, 2vw, 10px);
      align-items: start;
    }
    @media(min-width: 768px){
      .side-list{ grid-template-columns: repeat(3, 1fr); } /* å¹³æ¿ 3 æ¬„ */
    }
    @media(min-width: 1024px){
      .side-list{ grid-template-columns: repeat(4, 1fr); } /* é›»è…¦ 4 æ¬„ */
    }
    
    .side-item{
      display: flex;
      align-items: center;
      gap: clamp(5px, 1.2vw, 7px);
      padding: clamp(7px, 1.8vw, 9px);
      background: #fff;
      border: 1px solid var(--border);
      border-radius: clamp(6px, 1.5vw, 8px);
      transition: all .2s ease;
    }
    .side-item:has(input:not([value="0"])){
      border-color: var(--primary);
      background: #fffbeb;
    }
    .side-item-name{
      flex: 1;
      font-size: clamp(14px, 3.2vw, 15px);
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      letter-spacing: 0.3px;
    }
    .side-item .qty-control{
      padding: clamp(1px, 0.3vw, 2px);
      flex-shrink: 0;
    }
    .side-item .qty-control input{
      width: clamp(28px, 7vw, 32px);
      font-size: clamp(13px, 3vw, 14px);
    }
    .side-item .qty-btn{
      width: clamp(20px, 5vw, 24px);
      height: clamp(20px, 5vw, 24px);
      font-size: clamp(12px, 3vw, 14px);
    }
    .side-item .eye-icon{
      cursor: pointer;
      font-size: clamp(16px, 4vw, 18px);
      opacity: 0.6;
      transition: all .2s ease;
      flex-shrink: 0;
    }
    .side-item .eye-icon:hover{
      opacity: 1;
      transform: scale(1.2);
    }
    
    /* åˆ†é¡å€å¡Š */
    .category-block{
      display: flex;
      flex-direction: column;
    }
    
    /* åˆ†é¡æ¨™é¡Œï¼ˆå¯é»æ“Šæ‘ºç–Šï¼‰ */
    .category-title{
      font-size: clamp(14px, 3.2vw, 15px);
      font-weight: 700;
      color: var(--primary);
      background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%);
      padding: clamp(10px, 2.5vw, 12px) clamp(12px, 3vw, 14px);
      border-radius: clamp(8px, 2vw, 10px);
      border: 1.5px solid #fed7aa;
      cursor: pointer;
      user-select: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all .2s ease;
      letter-spacing: 0.3px;
      line-height: 1.4;
    }
    .category-title:hover{
      background: linear-gradient(135deg, #ffedd5 0%, #fed7aa 100%);
    }
    .category-title:active{
      transform: scale(0.98);
    }
    .category-title .toggle-icon{
      font-size: clamp(16px, 4vw, 18px);
      transition: transform .2s ease;
    }
    .category-title.active .toggle-icon{
      transform: rotate(180deg);
    }
    
    /* åˆ†é¡å…§å®¹ï¼ˆå¯æ‘ºç–Šï¼‰ */
    .category-content{
      display: flex;
      flex-direction: column;
      gap: clamp(4px, 1vw, 5px);
      margin-top: clamp(4px, 1vw, 5px);
      max-height: 0;
      overflow: hidden;
      transition: max-height .3s ease;
    }
    .category-content.active{
      max-height: 2000px;
    }
    
    /* å•†å“å¡ç‰‡ */
    .product-card{
      background: #fff;
      border: 1.5px solid var(--border);
      border-radius: clamp(6px, 1.5vw, 10px);
      padding: clamp(6px, 1.5vw, 8px);
      transition: all .25s ease;
      position: relative;
    }
    .product-card:has(input[type="number"]:not([value="0"])){
      border-color: var(--primary);
      box-shadow: 0 2px 8px rgba(217,119,6,.15);
    }
    .product-card:active{ transform: scale(0.98); }
    
    /* ç¼ºè²¨å•†å“æ¨£å¼ */
    .product-card.out-of-stock{
      opacity: 0.6;
      pointer-events: none;
    }
    .product-card.out-of-stock .product-image-wrap{
      filter: grayscale(50%);
    }
    
    /* ç¼ºè²¨æ¨™ç±¤ */
    .out-of-stock-badge{
      position: absolute;
      top: 8px;
      right: 8px;
      background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
      color: #fff;
      padding: clamp(4px, 1vw, 6px) clamp(8px, 2vw, 12px);
      border-radius: clamp(4px, 1vw, 6px);
      font-size: clamp(11px, 2.5vw, 12px);
      font-weight: 700;
      z-index: 10;
      box-shadow: 0 2px 8px rgba(220, 38, 38, 0.4);
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 4px;
      animation: pulse 2s ease-in-out infinite;
    }
    .out-of-stock-badge::before{
      content: 'âœ•';
      font-size: clamp(12px, 2.8vw, 14px);
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }
    
    /* èœå–®åœ–ç‰‡å®¹å™¨ */
    .menu-image-wrap{
      position: relative;
      width: 100%;
      padding-top: 75%; /* 4:3 æ¯”ä¾‹ */
      border-radius: clamp(6px, 1.5vw, 10px);
      overflow: hidden;
      cursor: pointer;
      background: #f3f4f6;
      border: 1.5px solid var(--border);
      transition: all .25s ease;
    }
    .menu-image-wrap:hover{
      border-color: var(--primary);
      box-shadow: 0 4px 12px rgba(217,119,6,.2);
    }
    .menu-image{
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: contain; /* å®Œæ•´é¡¯ç¤ºåœ–ç‰‡ */
      object-position: center;
      transition: transform .3s ease;
    }
    .menu-image-wrap:hover .menu-image{
      transform: scale(1.02);
    }
    .menu-image-wrap::after{
      content: 'ğŸ” é»æ“Šæ”¾å¤§';
      position: absolute;
      bottom: 8px;
      right: 8px;
      background: rgba(0,0,0,.7);
      color: #fff;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: clamp(10px, 2.2vw, 11px);
      opacity: 0;
      transition: opacity .2s ease;
    }
    .menu-image-wrap:hover::after{
      opacity: 1;
    }
    
    .product-image-wrap{
      position: relative;
      width: 100%;
      padding-top: 75%; /* æ”¹ç‚º 4:3 æ¯”ä¾‹ï¼Œè®“åœ–ç‰‡ä¸é‚£éº¼å¤§ */
      border-radius: clamp(4px, 1vw, 6px);
      overflow: hidden;
      margin-bottom: clamp(5px, 1.2vw, 6px);
      cursor: pointer;
      background: #f3f4f6;
    }
    .product-image{
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover; /* ç½®ä¸­è£åˆ‡ */
      object-position: center;
      transition: transform .3s ease;
    }
    .product-image-wrap:hover .product-image{
      transform: scale(1.05);
    }
    .product-image-wrap::after{
      content: 'ğŸ”';
      position: absolute;
      top: 4px;
      right: 4px;
      background: rgba(0,0,0,.6);
      color: #fff;
      width: clamp(20px, 5vw, 24px);
      height: clamp(20px, 5vw, 24px);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: clamp(10px, 2.5vw, 12px);
      opacity: 0;
      transition: opacity .2s ease;
    }
    .product-image-wrap:hover::after{
      opacity: 1;
    }
    
    .product-name{
      font-size: clamp(13px, 2.8vw, 14px);
      font-weight: 600;
      margin-bottom: clamp(3px, 0.8vw, 4px);
      color: var(--text);
      line-height: 1.3;
      /* ğŸ”§ é•¿æ–‡æœ¬å¤„ç† */
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2; /* æœ€å¤šæ˜¾ç¤º2è¡Œ */
      line-clamp: 2; /* æ ‡å‡†å±æ€§ */
      -webkit-box-orient: vertical;
      word-break: break-word;
    }
    .product-price{
      font-size: clamp(14px, 3vw, 15px);
      font-weight: 700;
      color: var(--primary);
      margin-bottom: clamp(5px, 1.2vw, 6px);
    }
    .product-qty{
      display: flex;
      align-items: center;
      gap: clamp(4px, 1vw, 5px);
    }
    .product-qty input{
      width: 100%;
      text-align: center;
      padding: clamp(5px, 1.2vw, 6px);
      font-weight: 600;
      font-size: clamp(13px, 3vw, 15px);
    }
    .product-qty select{
      padding: clamp(4px, 1vw, 5px) clamp(6px, 1.5vw, 8px);
      font-size: clamp(10px, 2.2vw, 12px);
      margin-top: clamp(4px, 1vw, 5px);
    }
    
    /* æ•¸é‡æ§åˆ¶æŒ‰éˆ• */
    .qty-control{
      display: flex;
      align-items: center;
      gap: clamp(3px, 0.8vw, 4px);
      background: #fff;
      border: 1.5px solid var(--border);
      border-radius: clamp(6px, 1.5vw, 8px);
      padding: clamp(2px, 0.5vw, 3px);
      transition: all .2s ease;
    }
    .qty-control:has(input:not([value="0"])){
      border-color: var(--primary);
      background: #fffbeb;
    }
    .qty-btn{
      width: clamp(24px, 6vw, 28px);
      height: clamp(24px, 6vw, 28px);
      border: none;
      background: var(--primary);
      color: #fff;
      border-radius: clamp(4px, 1vw, 6px);
      font-size: clamp(14px, 3.5vw, 16px);
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all .2s ease;
      user-select: none;
      flex-shrink: 0;
      padding: 0;
      line-height: 1;
    }
    .qty-btn:active{
      transform: scale(0.9);
      background: var(--primary-dark);
    }
    .qty-btn:hover{
      background: var(--primary-dark);
    }
    .qty-control input{
      border: none;
      background: transparent;
      width: clamp(36px, 9vw, 42px);
      text-align: center;
      padding: clamp(4px, 1vw, 5px);
      font-weight: 600;
      font-size: clamp(14px, 3.2vw, 15px);
      appearance: textfield; /* æ¨™æº–å±¬æ€§ */
      -moz-appearance: textfield; /* Firefox */
    }
    .qty-control input::-webkit-outer-spin-button,
    .qty-control input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    .qty-control input:focus{
      box-shadow: none;
    }
    
    /* ç¸½è¨ˆ */
    .total-section{
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      padding: clamp(10px, 2.5vw, 14px);
      border-radius: var(--radius);
      margin: clamp(10px, 2.5vw, 12px) 0;
    }
    .total-row{
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .total-label{
      font-size: clamp(15px, 3.5vw, 16px);
      font-weight: 600;
    }
    .total-amount{
      font-size: clamp(22px, 5vw, 26px);
      font-weight: 800;
      color: var(--primary);
    }
    
    /* æŒ‰éˆ• */
    .btn-group{
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: clamp(8px, 2vw, 10px);
      margin-top: clamp(10px, 2.5vw, 12px);
    }
    button{
      padding: clamp(10px, 2.2vw, 12px) clamp(12px, 3vw, 16px);
      border: none;
      border-radius: clamp(6px, 1.5vw, 8px);
      font-size: clamp(14px, 3vw, 15px);
      font-weight: 700;
      cursor: pointer;
      transition: all .2s ease;
      font-family: inherit;
    }
    .btn-primary{
      background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
      color: #fff;
      box-shadow: 0 3px 10px rgba(217,119,6,.3);
    }
    .btn-primary:hover{ box-shadow: 0 4px 14px rgba(217,119,6,.4); transform: translateY(-1px); }
    .btn-primary:active{ transform: translateY(0); }
    
    .btn-ghost{
      background: #fff;
      color: var(--muted);
      border: 1.5px solid var(--border);
    }
    .btn-ghost:hover{ border-color: var(--muted); }
    
    /* è¨Šæ¯ */
    .message{
      margin-top: clamp(8px, 2vw, 10px);
      padding: clamp(8px, 2vw, 10px);
      border-radius: clamp(4px, 1vw, 6px);
      font-size: clamp(13px, 2.8vw, 14px);
      font-weight: 600;
    }
    .message.success{
      background: #d1fae5;
      color: var(--success);
      border: 1.5px solid var(--success);
    }
    .message.error{
      background: #fee2e2;
      color: var(--danger);
      border: 1.5px solid var(--danger);
    }
    
    /* é è¦½å€ */
    .preview-box{
      background: #f9fafb;
      padding: clamp(10px, 2.5vw, 12px);
      border-radius: clamp(6px, 1.5vw, 8px);
      border: 1.5px dashed var(--border);
      min-height: 80px;
      font-size: clamp(13px, 2.8vw, 14px);
      line-height: 1.6;
    }
    .preview-empty{
      color: var(--muted);
      text-align: center;
      padding: clamp(15px, 4vw, 20px);
    }
    .preview-item{
      padding: clamp(6px, 1.5vw, 8px) 0;
      border-bottom: 1px solid var(--border);
      /* ğŸ”§ é•¿æ–‡æœ¬å¤„ç† */
      word-break: break-word;
      line-height: 1.6;
    }
    .preview-item:last-child{ border-bottom: none; }
    .preview-item strong{
      display: inline-block;
      max-width: 60%;
      word-break: break-word;
    }
    
    /* Logo æ”¾å¤§æ¨¡æ…‹æ¡† */
    .modal{
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.8);
      z-index: 999;
      align-items: center;
      justify-content: center;
      padding: 20px;
      animation: fadeIn .2s ease;
    }
    .modal.active{ display: flex; }
    .modal-content{
      max-width: 90%;
      max-height: 90%;
      border-radius: var(--radius);
      animation: zoomIn .2s ease;
    }
    @keyframes fadeIn{ from{opacity:0} to{opacity:1} }
    @keyframes zoomIn{ from{transform:scale(.8)} to{transform:scale(1)} }
    @keyframes slideUp{ from{transform:translate(-50%, 100px); opacity:0} to{transform:translate(-50%, 0); opacity:1} }
    
    /* é è¦½+ç¸½è¨ˆå€åŸŸå®¹å™¨ */
    .summary-grid{
      display: grid;
      grid-template-columns: 1fr;
      gap: clamp(8px, 2vw, 10px);
    }
    
    /* å£å‘³å®¢è£½ç¶²æ ¼ */
    .taste-grid{
      display: grid;
      grid-template-columns: repeat(2, 1fr); /* æ‰‹æ©Ÿ 2x2 */
      gap: clamp(8px, 2vw, 10px);
    }
    
    /* éŸ¿æ‡‰å¼èª¿æ•´ */
    @media(min-width: 768px){
      .container{ padding: clamp(12px, 3vw, 18px); }
      .brand-header{ padding: clamp(16px, 4vw, 24px) clamp(16px, 3vw, 20px); }
      .summary-grid{ grid-template-columns: 1.2fr 0.8fr; } /* é›»è…¦ç‰ˆï¼šé è¦½è¼ƒå¯¬ï¼Œç¸½è¨ˆè¼ƒçª„ */
      .taste-grid{ grid-template-columns: repeat(4, 1fr); } /* é›»è…¦ç‰ˆï¼šä¸€è¡Œ 4 æ¬„ */
    }
    
    /* åº•éƒ¨ç‰ˆæƒä¿¡æ¯ */
    .footer{
      text-align: center;
      padding: clamp(20px, 5vw, 30px) clamp(12px, 3vw, 16px);
      color: var(--muted);
      font-size: clamp(10px, 2.2vw, 11px);
      line-height: 1.8;
      border-top: 1px solid var(--border);
      background: #fafafa;
      margin-top: clamp(20px, 5vw, 30px);
    }
    .footer a{
      color: var(--primary);
      text-decoration: none;
      font-weight: 600;
      transition: all .2s ease;
    }
    .footer a:hover{
      color: var(--primary-dark);
      text-decoration: underline;
    }
    .footer-warning{
      margin-top: 8px;
      font-size: clamp(9px, 2vw, 10px);
      color: #9ca3af;
    }
    
    /* è¼‰å…¥æç¤º */
    .loading-overlay{
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity .3s ease;
    }
    .loading-overlay.hidden{
      opacity: 0;
      pointer-events: none;
    }
    .loading-content{
      text-align: center;
      padding: clamp(20px, 5vw, 30px);
    }
    .loading-icon{
      font-size: clamp(48px, 12vw, 64px);
      margin-bottom: clamp(12px, 3vw, 16px);
      animation: bounce 1s ease-in-out infinite;
    }
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    .loading-text{
      font-size: clamp(14px, 3.5vw, 16px);
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 8px;
    }
    .loading-subtext{
      font-size: clamp(11px, 2.5vw, 12px);
      color: var(--muted);
    }
    
    /* é€²åº¦æ¢æ¨£å¼ */
    .loading-progress-container {
      width: 100%;
      max-width: 280px;
      margin: clamp(16px, 4vw, 20px) auto 0;
    }
    .loading-progress-bar {
      width: 100%;
      height: clamp(6px, 1.5vw, 8px);
      background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
      border-radius: 999px;
      overflow: hidden;
      position: relative;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .loading-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 50%, var(--primary) 100%);
      background-size: 200% 100%;
      border-radius: 999px;
      transition: width 0.3s ease;
      position: relative;
      animation: progressShine 2s ease-in-out infinite;
      box-shadow: 0 2px 8px rgba(217, 119, 6, 0.4);
    }
    @keyframes progressShine {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    .loading-progress-text {
      font-size: clamp(12px, 3vw, 13px);
      color: var(--primary);
      font-weight: 600;
      margin-top: clamp(8px, 2vw, 10px);
      text-align: center;
      min-height: 18px;
    }
    .loading-progress-percent {
      font-size: clamp(14px, 3.5vw, 16px);
      font-weight: 700;
      color: var(--primary);
    }
  </style>
</head>
<body>
  <!-- è¼‰å…¥æç¤ºé®ç½© -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
      <div class="loading-icon">ğŸ¥</div>
      <div class="loading-text">è¼‰å…¥ä¸­...</div>
      
      <!-- é€²åº¦æ¢ -->
      <div class="loading-progress-container">
        <div class="loading-progress-bar">
          <div class="loading-progress-fill" id="loadingProgressFill" style="width: 0%"></div>
        </div>
        <div class="loading-progress-text">
          <span id="loadingProgressPercent">0%</span>
          <span id="loadingProgressStatus" style="display: block; font-size: clamp(11px, 2.5vw, 12px); color: var(--muted); margin-top: 4px;">åˆå§‹åŒ–ä¸­...</span>
        </div>
      </div>
    </div>
  </div>
  
  <!-- å“ç‰Œ Header -->
  <header class="brand-header">
    <div class="brand-logo-wrap">
      <img 
        src="https://images.unsplash.com/photo-1509440159596-0249088772ff?w=200&h=200&fit=crop&q=80" 
        alt="å…­è’œåŒ…Â·é¤è»Š" 
        class="brand-logo"
        id="brandLogo"
      />
      <div>
        <h1 class="brand-title">å…­è’œåŒ…Â·é¤è»Š</h1>
        <p class="brand-subtitle">ğŸ“ å®šé»é¤è»Šï½œé è¨‚å–é¤</p>
      </div>
    </div>
    
    <!-- ğŸ”§ å¿«å–ç®¡ç†æŒ‰éˆ• -->
    <button 
      type="button"
      id="cacheManagerBtn"
      style="
        position: absolute;
        top: 12px;
        right: 12px;
        background: rgba(255,255,255,0.2);
        border: 1.5px solid rgba(255,255,255,0.3);
        color: #fff;
        width: clamp(32px, 8vw, 36px);
        height: clamp(32px, 8vw, 36px);
        border-radius: 50%;
        font-size: clamp(16px, 4vw, 18px);
        cursor: pointer;
        transition: all .2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
      "
      onclick="this.style.background='rgba(255,255,255,0.3)'"
      onmouseout="this.style.background='rgba(255,255,255,0.2)'"
      title="å¿«å–ç®¡ç†"
    >âš™ï¸</button>
    </header>

  <div class="container">
    <form id="orderForm" autocomplete="on">
      
      <!-- åŸºæœ¬è³‡æ–™å¡ç‰‡ -->
      <div class="card">
        <h2 class="section-title">è¨‚è³¼è³‡æ–™</h2>
        
        <!-- å ´åœ°é¸æ“‡ï¼ˆå…¨å¯¬é¡¯ç¤ºï¼‰ -->
        <div class="form-group">
          <label class="form-label">ğŸ“ å–é¤å ´åœ°<span class="required">*</span></label>
          <select required name="venue" id="venueSelect" style="border-color:var(--primary); font-weight:600; font-size:clamp(15px,3.5vw,16px);">
            <option value="">è«‹é¸æ“‡å–é¤å ´åœ°...</option>
          </select>
          <!-- ç•¶å‰å ´åœ°é¡¯ç¤º + åˆ·æ–°æŒ‰éˆ• -->
          <div id="currentVenueDisplay" style="display:none; margin-top:8px; padding:10px 14px; background:linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); border:1.5px solid #fbbf24; border-radius:8px; font-size:clamp(13px,3vw,14px); font-weight:600; color:#92400e;">
            <div style="display:flex; align-items:center; justify-content:space-between;">
              <div>
                <span style="display:inline-block; margin-right:6px;">ğŸ¯</span>
                <span>ç•¶å‰å ´åœ°ï¼š</span>
                <span id="currentVenueName" style="color:#b45309;"></span>
              </div>
              <button 
                type="button" 
                id="refreshVenueBtn"
                style="
                  padding:4px 10px; 
                  background:#fff; 
                  border:1.5px solid #fbbf24; 
                  border-radius:6px; 
                  font-size:clamp(11px,2.5vw,12px); 
                  color:#92400e; 
                  cursor:pointer; 
                  transition:all .2s ease;
                  font-weight:600;
                "
                onclick="this.style.background='#fef3c7'"
                onmouseout="this.style.background='#fff'"
              >ğŸ”„ åˆ·æ–°</button>
            </div>
          </div>
        </div>
        
        <div style="display:grid; grid-template-columns:repeat(2,1fr); gap:clamp(12px,3vw,16px);">
          <div class="form-group" style="margin-bottom:0">
            <label class="form-label">é¤ç¾¤å§“å & ç¾¤çµ„ID<span class="required">*</span></label>
            <input required name="name" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜ #A123" autocomplete="off" />
          </div>

          <div class="form-group" style="margin-bottom:0">
            <label class="form-label">æ‰‹æ©Ÿæœ«3ç¢¼æˆ–å…¨ç¢¼<span class="required">*</span></label>
            <input required name="phone" type="text" placeholder="ä¾‹å¦‚ï¼š123 æˆ– 0912345678" autocomplete="tel" />
          </div>
        </div>

        <div style="display:grid; grid-template-columns:repeat(2,1fr); gap:clamp(12px,3vw,16px); margin-top:clamp(14px,3.5vw,18px);">
          <div class="form-group" style="margin-bottom:0">
            <label class="form-label">å–é¤æ–¹å¼<span class="required">*</span></label>
            <select required name="method">
              <option value="">è¼‰å…¥ä¸­...</option>
            </select>
          </div>

          <div class="form-group" style="margin-bottom:0">
            <label class="form-label">é è¨ˆå–é¤æ™‚é–“<span class="required">*</span></label>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:clamp(8px,2vw,10px);">
              <select required id="etaHour" style="border-color:var(--accent); font-weight:600;">
                <option value="">æ™‚</option>
              </select>
              <select required id="etaMinute" style="border-color:var(--accent); font-weight:600;">
                <option value="">åˆ†</option>
              </select>
            </div>
            <input type="hidden" name="eta" id="etaCombined" />
          </div>
          </div>
        </div>

      <!-- å•†å“é¸æ“‡å€ -->
      <div class="card">
        <h2 class="section-title">å•†å“é¸æ“‡</h2>
        <div class="product-grid" id="products"></div>
      </div>

      <!-- å‚™è¨»èªªæ˜ -->
      <div class="card">
        <h2 class="section-title">å‚™è¨»èªªæ˜</h2>
        <div class="form-group" style="margin-bottom:0;">
          <label class="form-label">ğŸ’¬ å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
          <textarea name="note" placeholder="ä¾‹å¦‚ï¼šéœ€è¦åˆ†è¢‹ã€ç‰¹æ®Šéœ€æ±‚ç­‰"></textarea>
        </div>
      </div>

      <!-- è¨‚å–®é è¦½ + ç¸½è¨ˆï¼ˆå¤šæ¬„ä½ˆå±€ï¼‰ -->
      <div class="summary-grid">
        
        <!-- è¨‚å–®é è¦½ -->
        <div class="card">
          <h2 class="section-title">ğŸ“‹ è¨‚å–®é è¦½</h2>
          <div class="preview-box" id="preview">
            <div class="preview-empty">å°šæœªé¸æ“‡å•†å“</div>
          </div>
        </div>

        <!-- ç¸½è¨ˆèˆ‡æŒ‰éˆ• -->
        <div class="card">
          <div class="total-section">
            <div class="total-row">
              <span class="total-label">è¨‚å–®ç¸½é¡</span>
              <span class="total-amount" id="totalAmt">$0</span>
            </div>
          </div>

          <div class="btn-group">
            <button type="button" class="btn-ghost" id="resetBtn">æ¸…ç©ºé‡å¡«</button>
            <button type="submit" class="btn-primary">âœ“ é€å‡ºè¨‚å–®</button>
          </div>

          <div id="result"></div>
        </div>

      </div>

    </form>
    </div>

  <!-- åœ–ç‰‡æ”¾å¤§æ¨¡æ…‹æ¡† -->
  <div class="modal" id="imageModal">
    <img 
      src="" 
      alt=""
      class="modal-content"
      id="modalImage"
    />
  </div>

  <script>
    // === å•†å“é …ç›®ï¼ˆå¾å¾Œç«¯å‹•æ…‹è¼‰å…¥ï¼‰===
    let PRODUCTS = [];
    
    // åº«å­˜ç‹€æ…‹ï¼ˆå¾å¾Œç«¯å‹•æ…‹è¼‰å…¥ï¼‰
    let INVENTORY = {};
    
    // ç•¶å‰é¸æ“‡çš„å ´åœ°ï¼ˆè¨˜ä½ç”¨æˆ¶é¸æ“‡ï¼‰
    let CURRENT_VENUE = null;
    
    // ğŸ†• æœ€ä½æ¶ˆè²»é‡‘é¡ï¼ˆå¾ç³»çµ±è¨­å®šè®€å–ï¼‰
    let MIN_ORDER_AMOUNT = 0;
    
    // ğŸš€ å ´åœ°è³‡æ–™å¿«å–ï¼ˆé¿å…é‡è¤‡è¼‰å…¥ï¼‰
    const VENUE_CACHE = {};
    const CACHE_EXPIRY_TIME = 5 * 60 * 1000; // å¿«å–æœ‰æ•ˆæœŸï¼š5åˆ†é˜
    const CACHE_STORAGE_KEY = 'venue_cache_WEB002_v1'; // LocalStorage å„²å­˜éµåï¼ˆæ¯å€‹ç¶²ç«™ç¨ç«‹ï¼Œé¿å…è¡çªï¼‰
    
    // ğŸš€ æª¢æŸ¥å¿«å–æ˜¯å¦éæœŸ
    function isCacheValid(cacheData) {
      if (!cacheData || !cacheData.timestamp) return false;
      const now = Date.now();
      return (now - cacheData.timestamp) < CACHE_EXPIRY_TIME;
    }
    
    // ğŸ’¾ å¾ LocalStorage è¼‰å…¥å¿«å–
    function loadCacheFromStorage() {
      try {
        const stored = localStorage.getItem(CACHE_STORAGE_KEY);
        if (stored) {
          const parsed = JSON.parse(stored);
          // æª¢æŸ¥æ¯å€‹å ´åœ°çš„å¿«å–æ˜¯å¦éæœŸ
          Object.keys(parsed).forEach(venueCode => {
            if (isCacheValid(parsed[venueCode])) {
              VENUE_CACHE[venueCode] = parsed[venueCode];
              console.log(`ğŸ’¾ å¾ LocalStorage æ¢å¾©å¿«å–ï¼š${venueCode}`);
            }
          });
          console.log(`âœ… å·²è¼‰å…¥ ${Object.keys(VENUE_CACHE).length} å€‹å ´åœ°å¿«å–`);
        }
      } catch (err) {
        console.warn('âš ï¸ ç„¡æ³•å¾ LocalStorage è¼‰å…¥å¿«å–:', err);
      }
    }
    
    // ğŸ’¾ å„²å­˜å¿«å–åˆ° LocalStorage
    function saveCacheToStorage() {
      try {
        const cacheString = JSON.stringify(VENUE_CACHE);
        const cacheSize = new Blob([cacheString]).size;
        const maxSize = 5 * 1024 * 1024; // 5MB é™åˆ¶
        
        // ğŸš€ æ€§èƒ½å„ªåŒ–ï¼šæª¢æŸ¥ LocalStorage å¤§å°ï¼Œé¿å…è¶…å‡ºé™åˆ¶
        if (cacheSize > maxSize) {
          console.warn('âš ï¸ å¿«å–éå¤§ï¼Œæ¸…ç†èˆŠå¿«å–');
          // åªä¿ç•™æœ€æ–°çš„ 50% å¿«å–
          const entries = Object.entries(VENUE_CACHE);
          entries.sort((a, b) => (b[1].timestamp || 0) - (a[1].timestamp || 0));
          const toKeep = entries.slice(0, Math.floor(entries.length / 2));
          Object.keys(VENUE_CACHE).forEach(key => delete VENUE_CACHE[key]);
          toKeep.forEach(([key, value]) => VENUE_CACHE[key] = value);
        }
        
        localStorage.setItem(CACHE_STORAGE_KEY, JSON.stringify(VENUE_CACHE));
        if (window.DEBUG_MODE) console.log('ğŸ’¾ å¿«å–å·²å„²å­˜åˆ° LocalStorage');
      } catch (err) {
        // QuotaExceededError æˆ–å…¶ä»–éŒ¯èª¤
        if (err.name === 'QuotaExceededError') {
          console.warn('âš ï¸ LocalStorage ç©ºé–“ä¸è¶³ï¼Œæ¸…ç†èˆŠå¿«å–');
          // æ¸…ç†æœ€èˆŠçš„å¿«å–
          const entries = Object.entries(VENUE_CACHE);
          entries.sort((a, b) => (a[1].timestamp || 0) - (b[1].timestamp || 0));
          const toDelete = entries.slice(0, Math.floor(entries.length / 2));
          toDelete.forEach(([key]) => delete VENUE_CACHE[key]);
          try {
            localStorage.setItem(CACHE_STORAGE_KEY, JSON.stringify(VENUE_CACHE));
          } catch (retryErr) {
            console.warn('âš ï¸ æ¸…ç†å¾Œä»ç„¡æ³•å„²å­˜å¿«å–:', retryErr);
          }
        } else {
          console.warn('âš ï¸ ç„¡æ³•å„²å­˜å¿«å–åˆ° LocalStorage:', err);
        }
      }
    }
    
    // ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰å¿«å–
    function clearAllCache() {
      Object.keys(VENUE_CACHE).forEach(key => delete VENUE_CACHE[key]);
      localStorage.removeItem(CACHE_STORAGE_KEY);
      console.log('ğŸ—‘ï¸ æ‰€æœ‰å¿«å–å·²æ¸…é™¤');
    }
    
    // ğŸ“Š å–å¾—å¿«å–è³‡è¨Š
    function getCacheInfo() {
      const cacheCount = Object.keys(VENUE_CACHE).length;
      const cacheSize = new Blob([JSON.stringify(VENUE_CACHE)]).size;
      const cacheSizeKB = (cacheSize / 1024).toFixed(2);
      return { cacheCount, cacheSizeKB };
    }
    
    // ğŸ–¼ï¸ åœ–ç‰‡é åŠ è¼‰å¿«å–
    const IMAGE_CACHE = new Set(); // å·²è¼‰å…¥çš„åœ–ç‰‡ URL
    const IMAGE_PRELOAD_QUEUE = []; // å¾…é è¼‰å…¥çš„åœ–ç‰‡éšŠåˆ—
    let isPreloadingImages = false;
    
    // ğŸ–¼ï¸ é è¼‰å…¥å–®å¼µåœ–ç‰‡
    function preloadImage(url) {
      return new Promise((resolve, reject) => {
        if (IMAGE_CACHE.has(url)) {
          resolve(url);
          return;
        }
        
        const img = new Image();
        img.onload = () => {
          IMAGE_CACHE.add(url);
          resolve(url);
        };
        img.onerror = () => reject(url);
        img.src = url;
      });
    }
    
    // ğŸ–¼ï¸ æ‰¹æ¬¡é è¼‰å…¥åœ–ç‰‡ï¼ˆé™æµï¼Œé¿å…ä¸€æ¬¡è¼‰å…¥å¤ªå¤šï¼‰
    async function batchPreloadImages(urls, concurrency = 3) {
      if (isPreloadingImages) return;
      isPreloadingImages = true;
      
      console.log(`ğŸ–¼ï¸ é–‹å§‹é è¼‰å…¥ ${urls.length} å¼µåœ–ç‰‡...`);
      
      const chunks = [];
      for (let i = 0; i < urls.length; i += concurrency) {
        chunks.push(urls.slice(i, i + concurrency));
      }
      
      let loadedCount = 0;
      for (const chunk of chunks) {
        await Promise.allSettled(chunk.map(url => preloadImage(url)));
        loadedCount += chunk.length;
        console.log(`ğŸ–¼ï¸ å·²è¼‰å…¥ ${loadedCount}/${urls.length} å¼µåœ–ç‰‡`);
      }
      
      isPreloadingImages = false;
      console.log('âœ… åœ–ç‰‡é è¼‰å…¥å®Œæˆï¼');
    }
    
    // ğŸ–¼ï¸ å¾å ´åœ°è³‡æ–™ä¸­æå–æ‰€æœ‰åœ–ç‰‡ URL
    function extractImageUrls(venueData) {
      const urls = [];
      
      // å¾å•†å“åˆ—è¡¨æå–
      if (venueData.products) {
        venueData.products.forEach(p => {
          if (p.imageUrl) urls.push(p.imageUrl);
          if (p.img) urls.push(p.img);
        });
      }
      
      // å¾ mainItems æå–
      if (venueData.mainItems) {
        venueData.mainItems.forEach(item => {
          if (item.imageUrl) urls.push(item.imageUrl);
          if (item.img) urls.push(item.img);
        });
      }
      
      return [...new Set(urls)]; // å»é‡
    }
    
    // ğŸš€ å·¥å…·å‡½æ•°ï¼šé˜²æŠ–ï¼ˆé¿å…é¢‘ç¹è®¡ç®—ï¼‰
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    
    // ğŸ§® éšæ¢¯åƒ¹æ ¼è¨ˆç®—å‡½æ•¸ï¼ˆå‹•æ…‹è¦åŠƒç‰ˆæœ¬ï¼‰
    function calculateTierPrice(quantity, basePrice, priceRules) {
      if (quantity <= 0) return 0;
      
      // å¦‚æœæ²’æœ‰éšæ¢¯åƒ¹æ ¼ï¼Œä½¿ç”¨åŸºç¤å–®åƒ¹
      if (!priceRules || priceRules.length === 0) {
        return quantity * basePrice;
      }
      
      // ğŸ¯ ä½¿ç”¨å‹•æ…‹è¦åŠƒæ‰¾æœ€å„ªè§£
      const dp = new Array(quantity + 1).fill(Infinity);
      dp[0] = 0;
      
      // å°æ–¼æ¯å€‹æ•¸é‡ï¼Œå˜—è©¦æ‰€æœ‰å¯èƒ½çš„éšæ¢¯è¦å‰‡
      for (let i = 1; i <= quantity; i++) {
        // æ–¹æ¡ˆ1ï¼šè²·å–®å€‹ï¼ˆç”¨åŸºç¤å–®åƒ¹ï¼‰
        dp[i] = dp[i - 1] + basePrice;
        
        // æ–¹æ¡ˆ2-Nï¼šä½¿ç”¨å„ç¨®éšæ¢¯è¦å‰‡
        for (const rule of priceRules) {
          if (i >= rule.qty) {
            // å¦‚æœç•¶å‰æ•¸é‡è¶³å¤ ä½¿ç”¨é€™å€‹éšæ¢¯
            const priceWithRule = dp[i - rule.qty] + rule.price;
            if (priceWithRule < dp[i]) {
              dp[i] = priceWithRule;
            }
          }
        }
      }
      
      return dp[quantity];
    }
    
    // ğŸ’¡ è·å–ä¼˜æƒ æç¤ºï¼ˆä¹°Xä¸ªæ›´åˆ’ç®—ï¼‰
    function getTierPriceTip(quantity, basePrice, priceRules) {
      if (!priceRules || priceRules.length === 0) return '';
      
      // æŸ¥æ‰¾ä¸‹ä¸€ä¸ªä¼˜æƒ é˜¶æ¢¯
      for (const rule of priceRules) {
        if (quantity < rule.qty) {
          const diff = rule.qty - quantity;
          const currentPrice = calculateTierPrice(quantity, basePrice, priceRules);
          const nextPrice = calculateTierPrice(rule.qty, basePrice, priceRules);
          const avgCurrent = Math.round(currentPrice / quantity);
          const avgNext = Math.round(nextPrice / rule.qty);
          
          if (avgNext < avgCurrent) {
            return `ğŸ’¡ å†è²· ${diff} å€‹ï¼Œå¹³å‡æ¯å€‹åªè¦ $${avgNext}`;
          }
        }
      }
      
      return '';
    }
    
    // ğŸš€ è¨ˆç®—å‡½æ•¸ï¼ˆç¨å¾Œå®šç¾©å®Œæ•´é‚è¼¯ï¼‰
    // ğŸ”§ é¿å…èˆ‡ app.js è¡çªï¼šåªåœ¨æœªå®šç¾©æ™‚è²æ˜
    if (typeof recalc === 'undefined') {
      var recalc = () => {};
    }
    if (typeof debouncedRecalc === 'undefined') {
      var debouncedRecalc = () => {};
    }
    

    // ============================================
    // ğŸ” æˆæ¬Šè¨­å®šï¼ˆæ¯å€‹å®¢æˆ¶ä¸åŒï¼‰
    // ============================================
    const WEBSITE_ID = "WEB002"; // âš ï¸ æ¯å€‹å®¢æˆ¶çš„ç¶²ç«™IDä¸åŒï¼Œè«‹å‹¿ä¿®æ”¹
    const AUTH_API = "https://script.google.com/macros/s/AKfycbyDsD6V7cP239XOFvQ3mRRPILxQsBagt5UIFTJszkfsSf_1SXiDAzIav-F2dXPRU22X/exec"; // æˆæ¬Šç®¡ç†ä¸­å¿ƒ API ç¶²å€
    
    // Google Apps Script URLï¼ˆå®¢æˆ¶çš„è¨‚å–®ç³»çµ±ï¼‰
    const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbxaZrUtgjmHpvNdny5v1jbTAVoH08VoC92gApqy64MyAf_-Iaz82F7rE00iFuKf9mDJ/exec"; // âœ… å·²æ›´æ–°ç‚ºæ–°çš„éƒ¨ç½²ç¶²å€

    // ====== æˆæ¬Šæª¢æŸ¥ ======
    async function checkAuthorization() {
      try {
        // å¦‚æœæ²’æœ‰è¨­å®šæˆæ¬Š APIï¼Œè·³éæª¢æŸ¥ï¼ˆé–‹ç™¼æ¨¡å¼ï¼‰
        if (!AUTH_API || AUTH_API === 'YOUR_AUTH_API_URL_HERE') {
          console.log('âš ï¸ æœªè¨­å®šæˆæ¬ŠAPIï¼Œè·³éæˆæ¬Šæª¢æŸ¥');
          return { authorized: true };
        }
        
        const res = await fetch(`${AUTH_API}?action=checkAuth&websiteId=${WEBSITE_ID}`);
        const data = await res.json();
        
        if (!data.ok) {
          console.error('æˆæ¬Šæª¢æŸ¥å¤±æ•—:', data.msg);
          return { authorized: false, msg: data.msg };
        }
        
        return data;
      } catch (err) {
        console.error('æˆæ¬Šæª¢æŸ¥éŒ¯èª¤:', err);
        // ç¶²è·¯éŒ¯èª¤æ™‚å…è¨±ç¹¼çºŒä½¿ç”¨ï¼ˆé¿å…èª¤é–ï¼‰
        return { authorized: true };
      }
    }
    
    // ====== é¡¯ç¤ºæˆæ¬Šå¤±æ•ˆé é¢ ======
    function showAuthExpiredPage(authData) {
      document.body.innerHTML = `
        <style>
          @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
          }
          @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
          }
          @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
          }
          .auth-container {
            animation: fadeIn 0.5s ease-out;
          }
          .lock-icon {
            animation: float 3s ease-in-out infinite;
          }
          .cta-button {
            animation: pulse 2s ease-in-out infinite;
          }
        </style>
        <div style="
          min-height: 100vh;
          display: flex;
          align-items: center;
          justify-content: center;
          background: linear-gradient(135deg, #fef9f3 0%, #faf5ed 100%);
          padding: 20px;
          position: relative;
          overflow: hidden;
        ">
          <!-- èƒŒæ™¯è£é£¾ -->
          <div style="
            position: absolute;
            top: -100px;
            right: -100px;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(217,119,6,0.1) 0%, transparent 70%);
            border-radius: 50%;
          "></div>
          <div style="
            position: absolute;
            bottom: -150px;
            left: -150px;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(245,158,11,0.08) 0%, transparent 70%);
            border-radius: 50%;
          "></div>
          
          <!-- ä¸»å¡ç‰‡ -->
          <div class="auth-container" style="
            max-width: 420px;
            width: 100%;
            background: white;
            border-radius: 16px;
            padding: 32px 28px;
            box-shadow: 0 20px 60px rgba(0,0,0,.15);
            text-align: center;
            position: relative;
            z-index: 1;
          ">
            <!-- é–åœ–æ¨™ -->
            <div class="lock-icon" style="
              width: 70px;
              height: 70px;
              margin: 0 auto 16px;
              background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 36px;
              box-shadow: 0 8px 24px rgba(220, 38, 38, 0.2);
            ">ğŸ”’</div>
            
            <!-- ç‹€æ…‹æ¨™ç±¤ -->
            <div style="
              display: inline-block;
              background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
              color: white;
              padding: 4px 12px;
              border-radius: 16px;
              font-size: 12px;
              font-weight: 600;
              margin-bottom: 12px;
              box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
            ">
              ${authData.reason === 'expired' ? 'ğŸ“… å·²åˆ°æœŸ' : 'â›” å·²åœç”¨'}
            </div>
            
            <!-- æ¨™é¡Œ -->
            <h1 style="
              font-size: 22px;
              font-weight: 800;
              background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
              -webkit-background-clip: text;
              -webkit-text-fill-color: transparent;
              background-clip: text;
              margin-bottom: 8px;
              line-height: 1.3;
            ">æˆæ¬Šå·²${authData.reason === 'expired' ? 'åˆ°æœŸ' : 'åœç”¨'}</h1>
            
            <!-- å•†å®¶è³‡è¨Š -->
            ${authData.businessName ? `
              <p style="
                font-size: 15px;
                color: #4b5563;
                font-weight: 600;
                margin-bottom: 16px;
              ">
                ğŸª ${authData.businessName}
              </p>
            ` : ''}
            
            <!-- è©³ç´°è³‡è¨Šå¡ç‰‡ -->
            <div style="
              background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
              border-radius: 12px;
              padding: 14px;
              margin: 16px 0;
              text-align: left;
            ">
              ${authData.plan ? `
                <div style="
                  display: flex;
                  align-items: center;
                  margin-bottom: 8px;
                  padding-bottom: 8px;
                  border-bottom: 1px solid #e5e7eb;
                ">
                  <span style="color: #9ca3af; font-size: 13px; min-width: 75px;">è¨‚é–±æ–¹æ¡ˆ</span>
                  <span style="color: #1f2937; font-weight: 600; font-size: 14px;">${authData.plan}</span>
                </div>
              ` : ''}
              ${authData.expireDate ? `
                <div style="
                  display: flex;
                  align-items: center;
                ">
                  <span style="color: #9ca3af; font-size: 13px; min-width: 75px;">åˆ°æœŸæ—¥æœŸ</span>
                  <span style="color: #ef4444; font-weight: 600; font-size: 14px;">${authData.expireDate}</span>
                </div>
              ` : ''}
            </div>
            
            <!-- æç¤ºè¨Šæ¯ -->
            <div style="
              background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
              border: 2px solid #fbbf24;
              border-radius: 12px;
              padding: 16px;
              margin: 16px 0;
              box-shadow: 0 4px 12px rgba(251, 191, 36, 0.15);
            ">
              <p style="
                font-size: 14px;
                color: #92400e;
                line-height: 1.6;
                margin: 0;
                font-weight: 500;
              ">
                ${authData.plan === 'è©¦ç”¨æœŸ' 
                  ? 'ğŸ è©¦ç”¨æœŸå·²çµæŸï¼Œæ„Ÿè¬æ‚¨çš„è©¦ç”¨ï¼<br/>å¦‚éœ€ç¹¼çºŒä½¿ç”¨ï¼Œè«‹è¯ç¹«å®¢æœé¸æ“‡ä»˜è²»æ–¹æ¡ˆã€‚' 
                  : `ğŸ’¡ æ‚¨çš„è¨‚é–±å·²${authData.reason === 'expired' ? 'åˆ°æœŸ' : 'åœç”¨'}ï¼Œ<br/>è«‹è¯ç¹«å®¢æœé€²è¡ŒçºŒè²»ã€‚`
                }
              </p>
            </div>
            
            <!-- CTA æŒ‰éˆ• -->
            <a 
              href="https://lin.ee/YyXagFg" 
              target="_blank"
              class="cta-button"
              style="
                display: inline-flex;
                align-items: center;
                gap: 6px;
                background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%);
                color: white;
                padding: 13px 32px;
                border-radius: 10px;
                text-decoration: none;
                font-weight: 700;
                font-size: 15px;
                box-shadow: 0 6px 20px rgba(217,119,6,.4);
                transition: all .3s ease;
                margin-top: 4px;
              "
              onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 24px rgba(217,119,6,.5)'"
              onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 6px 20px rgba(217,119,6,.4)'"
            >
              ${authData.plan === 'è©¦ç”¨æœŸ' ? 'ğŸ’³ é¸æ“‡ä»˜è²»æ–¹æ¡ˆ' : 'ğŸ“ è¯ç¹«å®¢æœçºŒè²»'}
            </a>
            
            <!-- æ¬¡è¦æŒ‰éˆ• -->
            <div style="margin-top: 12px;">
              <a 
                href="javascript:location.reload()" 
                style="
                  display: inline-block;
                  color: #6b7280;
                  font-size: 13px;
                  text-decoration: none;
                  padding: 6px 14px;
                  border-radius: 6px;
                  transition: all .2s ease;
                "
                onmouseover="this.style.color='#d97706'; this.style.background='#fef3c7'"
                onmouseout="this.style.color='#6b7280'; this.style.background='transparent'"
              >
                ğŸ”„ é‡æ–°æ•´ç†
              </a>
            </div>
            
            <!-- åº•éƒ¨è³‡è¨Š -->
            <div style="
              margin-top: 20px;
              padding-top: 16px;
              border-top: 1px solid #e5e7eb;
            ">
              <p style="
                font-size: 11px;
                color: #9ca3af;
                margin: 0;
              ">
                ç¶²ç«™ID: <code style="
                  background: #f3f4f6;
                  padding: 2px 6px;
                  border-radius: 4px;
                  color: #6b7280;
                  font-family: monospace;
                  font-size: 10px;
                ">${WEBSITE_ID}</code>
              </p>
              <p style="
                font-size: 10px;
                color: #d1d5db;
                margin: 6px 0 0;
              ">
                Â© 2025 å¿«é–ƒé¤è»Šå°å¹«æ‰‹ Â· æˆæ¬Šç®¡ç†ç³»çµ±
              </p>
            </div>
          </div>
        </div>
      `;
    }
    
    // ====== é¡¯ç¤ºå³å°‡åˆ°æœŸè­¦å‘Š ======
    // ğŸ”§ ä½¿ç”¨å…¨å±€æ¨™èªŒé˜²æ­¢é‡è¤‡é¡¯ç¤ºï¼ˆèˆ‡ app.js å…±äº«ï¼‰
    if (typeof window.expiryWarningShown === 'undefined') {
      window.expiryWarningShown = false;
    }
    
    function showExpiryWarning(daysLeft, expireDate, authData) {
      // ğŸ”§ é˜²æ­¢é‡è¤‡é¡¯ç¤ºï¼ˆæª¢æŸ¥å…¨å±€æ¨™èªŒï¼‰
      if (window.expiryWarningShown) {
        console.log('â­ï¸ è­¦å‘Šå·²é¡¯ç¤ºï¼Œè·³éé‡è¤‡é¡¯ç¤ºï¼ˆindex.htmlï¼‰');
        return;
      }
      
      // ğŸ”§ é©—è­‰ï¼šåªæœ‰ç•¶ daysLeft å’Œ expireDate éƒ½æœ‰æœ‰æ•ˆå€¼æ™‚æ‰é¡¯ç¤ºè­¦å‘Š
      if (!daysLeft || daysLeft === undefined || daysLeft === null || 
          !expireDate || expireDate === undefined || expireDate === null || expireDate === 'undefined') {
        console.log('â­ï¸ è·³éé¡¯ç¤ºåˆ°æœŸè­¦å‘Šï¼ˆæ•¸æ“šä¸å®Œæ•´ï¼Œindex.htmlï¼‰');
        return; // ä¸é¡¯ç¤ºè­¦å‘Š
      }
      
      // ğŸ”§ æ¨™è¨˜å·²é¡¯ç¤ºï¼ˆä½¿ç”¨å…¨å±€æ¨™èªŒï¼‰
      window.expiryWarningShown = true;
      
      const isTrial = authData.isTrial || false;
      const plan = authData.plan || '';
      
      const warningBanner = document.createElement('div');
      
      // è©¦ç”¨æœŸå’Œä»˜è²»æ–¹æ¡ˆä½¿ç”¨ä¸åŒé¡è‰²
      const bgColor = isTrial 
        ? 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)' 
        : 'linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%)';
      const textColor = isTrial ? '#fff' : '#78350f';
      
      warningBanner.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: ${bgColor};
        color: ${textColor};
        padding: 12px 20px;
        text-align: center;
        font-size: 14px;
        font-weight: 600;
        z-index: 9999;
        box-shadow: 0 2px 10px rgba(251, 191, 36, 0.3);
      `;
      
      // æ ¹æ“šè¨‚é–±æ–¹æ¡ˆé¡¯ç¤ºä¸åŒè¨Šæ¯
      let message = '';
      if (isTrial) {
        message = `ğŸ è©¦ç”¨æœŸå³å°‡çµæŸï¼ˆå‰©é¤˜ ${daysLeft} å¤©ï¼Œ${expireDate}ï¼‰ï¼Œè«‹è¯ç¹«å®¢æœé¸æ“‡ä»˜è²»æ–¹æ¡ˆ`;
      } else {
        message = `âš ï¸ ${plan} å³å°‡åˆ°æœŸï¼ˆå‰©é¤˜ ${daysLeft} å¤©ï¼Œ${expireDate}ï¼‰ï¼Œè«‹ç›¡å¿«çºŒè²»ä»¥å…å½±éŸ¿ä½¿ç”¨`;
      }
      
      warningBanner.innerHTML = message;
      document.body.insertBefore(warningBanner, document.body.firstChild);
      
      // èª¿æ•´ header ä½ç½®é¿å…è¢«é®æ“‹
      const header = document.querySelector('.brand-header');
      if (header) {
        header.style.marginTop = '44px';
      }
    }

    // ====== è¼‰å…¥åº«å­˜ç‹€æ…‹ ======
    async function loadInventory(venue) {
      try {
        // å¦‚æœæ²’æœ‰æŒ‡å®šå ´åœ°ï¼Œä½¿ç”¨ç•¶å‰é¸æ“‡çš„å ´åœ°
        const targetVenue = venue || CURRENT_VENUE;
        
        // æ§‹å»º API ç¶²å€ï¼ˆå¦‚æœæœ‰å ´åœ°å°±åŠ ä¸Šå ´åœ°åƒæ•¸ï¼‰
        let apiUrl = `${GAS_ENDPOINT}?action=getInventory`;
        if (targetVenue) {
          apiUrl += `&venue=${targetVenue}`;
        }
        
        const res = await fetch(apiUrl);
        const data = await res.json();
        
        if (data.ok) {
          INVENTORY = data.inventory;
          console.log('âœ… åº«å­˜å·²è¼‰å…¥:', INVENTORY);
          
          // ğŸ”„ å…¼å®¹è™•ç†ï¼šæ”¯æ´ products æˆ– mainItems
          let productsList = [];
          
          if (data.products && data.products.length > 0) {
            // æ–°ç‰ˆï¼šç›´æ¥ä½¿ç”¨ products
            productsList = data.products;
          } else if (data.mainItems && data.mainItems.length > 0) {
            // èˆŠç‰ˆï¼šå¾ mainItems è½‰æ›ï¼Œä¸¦å¾ inventory ä¸­è®€å–åƒ¹æ ¼
            productsList = data.mainItems.map(item => {
              const invData = INVENTORY[item.name] || {};
              return {
                name: item.name,
                img: item.imageUrl || invData.imageUrl || item.img || '',
                price: 0 // å…­è’œåŒ…ç‰ˆæœ¬ï¼šæ¯å€‹å•†å“åƒ¹æ ¼éœ€å¾åº«å­˜è¡¨æˆ–å…¶ä»–ä¾†æºè®€å–
              };
            });
          }
          
          if (productsList.length > 0) {
            PRODUCTS = productsList;
            console.log('âœ… å•†å“åˆ—è¡¨å·²è¼‰å…¥:', PRODUCTS);
            console.log('ğŸ”„ ä½¿ç”¨å¾Œç«¯å•†å“åˆ—è¡¨ï¼Œé‡æ–°ç”Ÿæˆå•†å“å¡ç‰‡');
            generateProducts(PRODUCTS);
          }
          
          // æ›´æ–°å•†å“å¡ç‰‡çš„ç¼ºè²¨ç‹€æ…‹
          updateStockStatus(true); // å¼·åˆ¶æ›´æ–°ï¼ˆé é¢åˆå§‹åŒ–è¼‰å…¥ï¼‰
        }
      } catch (err) {
        console.warn('âš ï¸ ç„¡æ³•è¼‰å…¥åº«å­˜ï¼Œä½¿ç”¨é è¨­è¨­å®š:', err);
      }
    }

    // ====== è¼‰å…¥ç³»çµ±è¨­å®šï¼ˆæ™‚é–“ã€å–é¤æ–¹å¼ç­‰ï¼‰ ======
    async function loadConfig() {
      try {
        const res = await fetch(`${GAS_ENDPOINT}?action=getConfig`);
        const data = await res.json();
        
        if (data.ok) {
          console.log('ç³»çµ±è¨­å®šå·²è¼‰å…¥:', data);
          
          // å‹•æ…‹ç”Ÿæˆå–é¤æ™‚é–“é¸é …
          if (data.timeOptions) {
            updateTimeOptions(data.timeOptions.hours, data.timeOptions.minutes);
          }
          
          // å‹•æ…‹ç”Ÿæˆå–é¤æ–¹å¼é¸é …
          if (data.methodOptions) {
            updateMethodOptions(data.methodOptions);
          }
          
          // å‹•æ…‹ç”Ÿæˆå ´åœ°é¸é …
          if (data.venueOptions) {
            updateVenueOptions(data.venueOptions);
          }
          
          // ğŸ†• è®€å–æœ€ä½æ¶ˆè²»é‡‘é¡
          if (data.minOrderAmount) {
            MIN_ORDER_AMOUNT = data.minOrderAmount;
            console.log('âœ… æœ€ä½æ¶ˆè²»é‡‘é¡:', MIN_ORDER_AMOUNT);
          }
        }
      } catch (err) {
        console.warn('ç„¡æ³•è¼‰å…¥ç³»çµ±è¨­å®šï¼Œä½¿ç”¨é è¨­é¸é …:', err);
      }
    }
    
    // ğŸš€ é è¼‰å…¥æ‰€æœ‰å ´åœ°è³‡æ–™ï¼ˆè®“åˆ‡æ›ç§’é–‹ï¼‰
    // ğŸ†• æ·»åŠ è«‹æ±‚é™æµæ©Ÿåˆ¶ï¼Œé¿å…åŒæ™‚ç™¼é€éå¤šè«‹æ±‚å°è‡´ 503 éŒ¯èª¤
    const PENDING_REQUESTS = new Set(); // è¿½è¹¤æ­£åœ¨é€²è¡Œçš„è«‹æ±‚
    const MAX_CONCURRENT_REQUESTS = 2; // æœ€å¤šåŒæ™‚ 2 å€‹è«‹æ±‚ï¼ˆé™ä½ä¸¦ç™¼æ•¸ï¼‰
    
    async function preloadAllVenues(venues) {
      console.log('ğŸš€ é–‹å§‹é è¼‰å…¥æ‰€æœ‰å ´åœ°è³‡æ–™...');
      const activeVenues = venues.filter(v => v.status !== 'æš«åœ');
      
      // ğŸ†• é™æµï¼šåˆ†æ‰¹è¼‰å…¥ï¼Œé¿å…åŒæ™‚ç™¼é€éå¤šè«‹æ±‚
      const batchSize = MAX_CONCURRENT_REQUESTS;
      for (let i = 0; i < activeVenues.length; i += batchSize) {
        const batch = activeVenues.slice(i, i + batchSize);
        
        // ä¸¦è¡Œè¼‰å…¥ç•¶å‰æ‰¹æ¬¡çš„å ´åœ°è³‡æ–™
        const preloadPromises = batch.map(async (venue) => {
          try {
            // å¦‚æœå¿«å–ä¸­å·²æœ‰ä¸”æœ‰æ•ˆï¼Œè·³é
            if (VENUE_CACHE[venue.code] && isCacheValid(VENUE_CACHE[venue.code])) {
              console.log(`âš¡ è·³éé è¼‰å…¥ï¼ˆå¿«å–æœ‰æ•ˆï¼‰ï¼š${venue.name}`);
              return;
            }
            
            // ğŸ†• æª¢æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒè«‹æ±‚æ­£åœ¨é€²è¡Œï¼ˆå»é‡ï¼‰
            const requestKey = `inventory_${venue.code}`;
            if (PENDING_REQUESTS.has(requestKey)) {
              console.log(`â­ï¸ è·³éé‡è¤‡è«‹æ±‚ï¼š${venue.name}`);
              return;
            }
            
            // æ¨™è¨˜è«‹æ±‚é€²è¡Œä¸­
            PENDING_REQUESTS.add(requestKey);
            
            try {
              const res = await fetch(`${GAS_ENDPOINT}?action=getInventory&venue=${venue.code}`);
              const data = await res.json();
              
              if (data.ok) {
                // å„²å­˜åˆ°å¿«å–
                VENUE_CACHE[venue.code] = {
                  inventory: data.inventory,
                  products: data.products,
                  mainItems: data.mainItems,
                  categories: data.categories,
                  timestamp: Date.now()
                };
                console.log(`âœ… é è¼‰å…¥å®Œæˆï¼š${venue.name}`);
              }
            } finally {
              // ç§»é™¤è«‹æ±‚æ¨™è¨˜
              PENDING_REQUESTS.delete(requestKey);
            }
          } catch (err) {
            console.warn(`âš ï¸ é è¼‰å…¥å¤±æ•—ï¼š${venue.name}`, err);
            // ç¢ºä¿ç§»é™¤è«‹æ±‚æ¨™è¨˜
            PENDING_REQUESTS.delete(`inventory_${venue.code}`);
          }
        });
        
        // ç­‰å¾…ç•¶å‰æ‰¹æ¬¡å®Œæˆå¾Œå†è™•ç†ä¸‹ä¸€æ‰¹
        await Promise.allSettled(preloadPromises);
        
        // ğŸ†• æ‰¹æ¬¡ä¹‹é–“æ·»åŠ å°å»¶é²ï¼Œé¿å…è«‹æ±‚éæ–¼å¯†é›†
        if (i + batchSize < activeVenues.length) {
          await new Promise(resolve => setTimeout(resolve, 200)); // å»¶é² 200ms
        }
      }
      
      // ğŸ’¾ å„²å­˜åˆ° LocalStorage
      saveCacheToStorage();
      
      console.log('ğŸ‰ æ‰€æœ‰å ´åœ°é è¼‰å…¥å®Œæˆï¼');
      
      // ğŸ–¼ï¸ æ€§èƒ½å„ªåŒ–ï¼šå»¶é²åœ–ç‰‡é è¼‰å…¥ï¼ˆåªåœ¨ç”¨æˆ¶äº¤äº’å¾Œæˆ–æ»¾å‹•æ™‚é è¼‰å…¥ï¼‰
      // ä½¿ç”¨ requestIdleCallback åœ¨ç€è¦½å™¨ç©ºé–’æ™‚é è¼‰å…¥
      const preloadImagesOnIdle = () => {
        const allImageUrls = [];
        Object.values(VENUE_CACHE).forEach(venueData => {
          const urls = extractImageUrls(venueData);
          allImageUrls.push(...urls);
        });
        
        if (allImageUrls.length > 0) {
          // åªé è¼‰å…¥å‰20å¼µåœ–ç‰‡ï¼Œå…¶ä»–æŒ‰éœ€è¼‰å…¥
          batchPreloadImages(allImageUrls.slice(0, 20), 2); // é™ä½ä¸¦ç™¼æ•¸
        }
      };
      
      if ('requestIdleCallback' in window) {
        requestIdleCallback(preloadImagesOnIdle, { timeout: 3000 });
      } else {
        setTimeout(preloadImagesOnIdle, 2000);
      }
    }
    
    // æ›´æ–°å ´åœ°é¸é …
    function updateVenueOptions(venues) {
      const venueSelect = document.getElementById('venueSelect');
      
      // ğŸ”§ é˜²æ­¢é‡è¤‡ç¶å®šäº‹ä»¶ï¼šå…ˆç§»é™¤èˆŠçš„äº‹ä»¶ç›£è½å™¨
      const newSelect = venueSelect.cloneNode(true);
      venueSelect.parentNode.replaceChild(newSelect, venueSelect);
      const freshVenueSelect = document.getElementById('venueSelect');
      
      // æ¸…ç©ºç¾æœ‰é¸é …ï¼ˆä¿ç•™ç¬¬ä¸€å€‹æç¤ºï¼‰
      freshVenueSelect.innerHTML = '<option value="">è«‹é¸æ“‡å–é¤å ´åœ°...</option>';
      
      // åªæ·»åŠ ç‡Ÿæ¥­ä¸­çš„å ´åœ°é¸é …ï¼ˆéš±è—æš«åœçš„å ´åœ°ï¼‰
      venues.forEach(venue => {
        // è·³éæš«åœç‡Ÿæ¥­çš„å ´åœ°
        if (venue.status === 'æš«åœ') {
          console.log(`â­ï¸ è·³éæš«åœå ´åœ°ï¼š${venue.name}`);
          return; // ä¸é¡¯ç¤ºåœ¨ä¸‹æ‹‰é¸å–®ä¸­
        }
        
        const option = document.createElement('option');
        option.value = venue.code;
        // æ·»åŠ è¡¨æƒ…ç¬¦è™Ÿ
        const emoji = 'ğŸ“';
        option.textContent = `${emoji} ${venue.name}`;
        
        freshVenueSelect.appendChild(option);
      });
      
      // ğŸš€ æ€§èƒ½å„ªåŒ–ï¼šæ™ºèƒ½é è¼‰å…¥ï¼ˆåªé è¼‰å…¥å‰3å€‹å ´åœ°ï¼Œå…¶ä»–æŒ‰éœ€è¼‰å…¥ï¼‰
      setTimeout(() => {
        // åªé è¼‰å…¥å‰3å€‹æ´»èºå ´åœ°ï¼Œæ¸›å°‘åˆå§‹è¼‰å…¥æ™‚é–“
        const activeVenues = venues.filter(v => v.status !== 'æš«åœ').slice(0, 3);
        if (activeVenues.length > 0) {
          preloadAllVenues(activeVenues);
        }
      }, 1000); // å»¶é² 1 ç§’ï¼Œè®“é é¢å…ˆå®Œæˆè¼‰å…¥
      
      // ç›£è½å ´åœ°é¸æ“‡è®Šæ›´äº‹ä»¶ï¼ˆä½¿ç”¨æ–°çš„ select å…ƒç´ ï¼‰
      freshVenueSelect.addEventListener('change', async function() {
        const selectedVenue = this.value;
        
        if (selectedVenue) {
          console.log(`ğŸ”„ åˆ‡æ›åˆ°å ´åœ°ï¼š${selectedVenue}`);
          
          // å¦‚æœä¹‹å‰å·²ç¶“é¸éå ´åœ°ï¼Œæ¸…ç©ºè³¼ç‰©è»Š
          if (CURRENT_VENUE && CURRENT_VENUE !== selectedVenue) {
            // é‡ç½®æ‰€æœ‰æ•¸é‡è¼¸å…¥ï¼ˆå¯¦æ™‚ç²å–ï¼ŒåŒ…å«å‹•æ…‹ç”Ÿæˆçš„ä¸»é¤ï¼‰
            document.querySelectorAll('.qty').forEach(q => {
              q.value = 0;
              q.setAttribute('value', '0');
            });
            recalc();
            console.log('ğŸ§¹ è³¼ç‰©è»Šå·²æ¸…ç©ºï¼ˆåˆ‡æ›å ´åœ°ï¼‰');
          }
          
          // è¨˜ä½ç•¶å‰é¸æ“‡çš„å ´åœ°
          CURRENT_VENUE = selectedVenue;
          
          // ğŸš€ æª¢æŸ¥å¿«å–ï¼šå¦‚æœå·²ç¶“è¼‰å…¥éé€™å€‹å ´åœ°ä¸”æœªéæœŸï¼Œç›´æ¥ä½¿ç”¨å¿«å–
          if (VENUE_CACHE[selectedVenue] && isCacheValid(VENUE_CACHE[selectedVenue])) {
            console.log('âš¡ ä½¿ç”¨å¿«å–è³‡æ–™ï¼ˆç§’é€Ÿè¼‰å…¥ï¼‰');
            const cachedData = VENUE_CACHE[selectedVenue];
            
            // ä½¿ç”¨å¿«å–çš„è³‡æ–™
            INVENTORY = cachedData.inventory || {};
            console.log('ğŸ“¦ å¿«å–åº«å­˜è³‡æ–™:', Object.keys(INVENTORY).length, 'é …');
            
            // ğŸ”„ å…¼å®¹è™•ç†ï¼šæ”¯æ´ products æˆ– mainItems
            let productsList = cachedData.products || cachedData.mainItems || [];
            
            // ğŸ”§ å¦‚æœå¿«å–ä¸­æ²’æœ‰å•†å“åˆ—è¡¨ï¼Œä¸æ‡‰è©²ä½¿ç”¨å…¨å±€ PRODUCTSï¼ˆå¯èƒ½æ˜¯å…¶ä»–å ´åœ°çš„ï¼‰
            if (productsList.length === 0) {
              console.warn('âš ï¸ å¿«å–ä¸­æ²’æœ‰å•†å“åˆ—è¡¨ï¼Œéœ€è¦é‡æ–°è¼‰å…¥');
              // æ¸…é™¤å¿«å–ï¼Œå¼·åˆ¶é‡æ–°è¼‰å…¥
              delete VENUE_CACHE[selectedVenue];
              // ç¹¼çºŒåŸ·è¡Œä¸‹é¢çš„ fetch é‚è¼¯
            } else {
              PRODUCTS = productsList;
              console.log('âœ… å¿«å–å•†å“åˆ—è¡¨:', productsList.length, 'é …');
              
              // å¿«é€Ÿæ›´æ–°ä»‹é¢ï¼ˆç„¡éœ€é‡æ–° fetchï¼‰
              generateProducts(productsList);
              updateStockStatus(true); // å¼·åˆ¶æ›´æ–°ï¼ˆä¸ç®¡ç”¨æˆ¶æ˜¯å¦æ­£åœ¨æ“ä½œï¼‰
              
              // æ›´æ–°ç•¶å‰å ´åœ°é¡¯ç¤º
              const currentVenueDisplay = document.getElementById('currentVenueDisplay');
              const currentVenueName = document.getElementById('currentVenueName');
              if (currentVenueDisplay && currentVenueName) {
                // ä½¿ç”¨ this å¼•ç”¨ç•¶å‰çš„ select å…ƒç´ 
                const selectedOption = this.options[this.selectedIndex];
                const venueName = selectedOption.textContent.replace('ğŸ“ ', '').trim();
                currentVenueName.textContent = venueName;
                currentVenueDisplay.style.display = 'block';
              }
              
              // é¡¯ç¤ºå¿«é€Ÿæç¤º
              const quickMsg = document.createElement('div');
              quickMsg.style.cssText = 'position:fixed; top:20px; right:20px; background:#059669; color:#fff; padding:12px 20px; border-radius:8px; z-index:9999; font-size:14px; font-weight:600;';
              quickMsg.textContent = 'âš¡ å ´åœ°å·²åˆ‡æ›';
              document.body.appendChild(quickMsg);
              setTimeout(() => {
                if (document.body.contains(quickMsg)) {
                  document.body.removeChild(quickMsg);
                }
              }, 1500);
              
              return; // ç›´æ¥è¿”å›ï¼Œä¸éœ€è¦ fetch
            }
          }
          
          // å¦‚æœæ²’æœ‰å¿«å–æˆ–å¿«å–ç„¡æ•ˆï¼Œé¡¯ç¤ºè¼‰å…¥æç¤º
          console.log('ğŸ“¡ å¾æœå‹™å™¨è¼‰å…¥å ´åœ°è³‡æ–™...');
          const loadingMsg = document.createElement('div');
          loadingMsg.id = 'venueLoadingMsg';
          loadingMsg.style.cssText = 'position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.8); color:#fff; padding:20px 40px; border-radius:10px; z-index:9999; font-size:16px; font-weight:600;';
          loadingMsg.textContent = 'ğŸ”„ è¼‰å…¥å ´åœ°è³‡æ–™ä¸­...';
          document.body.appendChild(loadingMsg);
          
          try {
            // ğŸš€ æª¢æŸ¥ç¶²è·¯ç‹€æ…‹
            if (!navigator.onLine) {
              document.body.removeChild(loadingMsg);
              alert('âš ï¸ ç¶²è·¯å·²æ–·ç·šï¼Œç„¡æ³•è¼‰å…¥å ´åœ°è³‡æ–™');
              return;
            }
            
            // ğŸ†• æª¢æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒè«‹æ±‚æ­£åœ¨é€²è¡Œï¼ˆå»é‡ï¼Œé¿å…é‡è¤‡è«‹æ±‚å°è‡´ 503ï¼‰
            const requestKey = `inventory_${selectedVenue}`;
            if (PENDING_REQUESTS.has(requestKey)) {
              console.log(`â­ï¸ è·³éé‡è¤‡è«‹æ±‚ï¼š${selectedVenue}`);
              document.body.removeChild(loadingMsg);
              return;
            }
            
            // æ¨™è¨˜è«‹æ±‚é€²è¡Œä¸­
            PENDING_REQUESTS.add(requestKey);
            
            try {
              // å¾æœå‹™å™¨è¼‰å…¥è©²å ´åœ°çš„åº«å­˜
              const res = await fetch(`${GAS_ENDPOINT}?action=getInventory&venue=${selectedVenue}`);
              const data = await res.json();
              
              console.log('ğŸ“¥ æœå‹™å™¨å›æ‡‰:', data.ok ? 'æˆåŠŸ' : 'å¤±æ•—', data);
              
              if (data.ok) {
                INVENTORY = data.inventory || {};
                console.log('âœ… å ´åœ°åº«å­˜å·²è¼‰å…¥:', Object.keys(INVENTORY).length, 'é …');
                
                // ğŸ”„ å…¼å®¹è™•ç†ï¼šæ”¯æ´ products æˆ– mainItems
                let productsList = [];
                
                if (data.products && data.products.length > 0) {
                  productsList = data.products;
                  console.log('âœ… ä½¿ç”¨ products åˆ—è¡¨:', productsList.length, 'é …');
                } else if (data.mainItems && data.mainItems.length > 0) {
                  productsList = data.mainItems.map(item => {
                    const invData = INVENTORY[item.name] || {};
                    return {
                      name: item.name,
                      img: item.imageUrl || invData.imageUrl || item.img || '',
                      price: 0
                    };
                  });
                  console.log('âœ… ä½¿ç”¨ mainItems åˆ—è¡¨:', productsList.length, 'é …');
                } else {
                  console.warn('âš ï¸ æœå‹™å™¨æœªè¿”å›å•†å“åˆ—è¡¨');
                }
                
                if (productsList.length > 0) {
                  PRODUCTS = productsList;
                  console.log('âœ… å ´åœ°å•†å“åˆ—è¡¨å·²è¼‰å…¥:', PRODUCTS.length, 'é …');
                  generateProducts(PRODUCTS);
                } else {
                  // ğŸ”§ å¦‚æœæ²’æœ‰å•†å“ï¼Œé¡¯ç¤ºæç¤º
                  console.warn('âš ï¸ è©²å ´åœ°æ²’æœ‰å•†å“');
                  const productsBox = document.querySelector('#products');
                  productsBox.innerHTML = `
                    <div style="
                      grid-column: 1 / -1;
                      text-align: center;
                      padding: clamp(40px, 10vw, 60px) clamp(20px, 5vw, 30px);
                      color: var(--muted);
                    ">
                      <div style="font-size: clamp(48px, 12vw, 64px); margin-bottom: 16px;">ğŸ“­</div>
                      <div style="font-size: clamp(16px, 4vw, 18px); font-weight: 600; margin-bottom: 8px;">è©²å ´åœ°ç›®å‰æ²’æœ‰å•†å“</div>
                      <div style="font-size: clamp(13px, 3vw, 14px);">è«‹é¸æ“‡å…¶ä»–å ´åœ°æˆ–è¯ç¹«ç®¡ç†å“¡</div>
                    </div>
                  `;
                }
                
                // æ›´æ–°å•†å“å¡ç‰‡çš„ç¼ºè²¨ç‹€æ…‹
                updateStockStatus(true); // å¼·åˆ¶æ›´æ–°ï¼ˆé¦–æ¬¡è¼‰å…¥ï¼‰
              
              // ğŸš€ å„²å­˜åˆ°å¿«å–ï¼ˆä¸‹æ¬¡åˆ‡æ›å°±æœƒç§’é–‹ï¼‰
              VENUE_CACHE[selectedVenue] = {
                inventory: data.inventory,
                products: data.products,
                mainItems: data.mainItems,
                categories: data.categories,
                timestamp: Date.now()
              };
              console.log(`ğŸ’¾ å ´åœ°è³‡æ–™å·²å¿«å–ï¼š${selectedVenue}`);
              
              // ğŸ’¾ åŒæ­¥åˆ° LocalStorage
              saveCacheToStorage();
              
              // ç§»é™¤è¼‰å…¥æç¤º
              document.body.removeChild(loadingMsg);
              
              // æ›´æ–°ç•¶å‰å ´åœ°é¡¯ç¤º
              const currentVenueDisplay = document.getElementById('currentVenueDisplay');
              const currentVenueName = document.getElementById('currentVenueName');
              if (currentVenueDisplay && currentVenueName) {
                // ä½¿ç”¨ this å¼•ç”¨ç•¶å‰çš„ select å…ƒç´ 
                const selectedOption = this.options[this.selectedIndex];
                const venueName = selectedOption.textContent.replace('ğŸ“ ', '').trim();
                
                currentVenueName.textContent = venueName;
                currentVenueDisplay.style.display = 'block';
              }
              
              // é¡¯ç¤ºæˆåŠŸæç¤º
              const successMsg = document.createElement('div');
              successMsg.style.cssText = 'position:fixed; top:20px; right:20px; background:#059669; color:#fff; padding:12px 20px; border-radius:8px; z-index:9999; font-size:14px; font-weight:600; animation: slideIn 0.3s ease;';
              successMsg.textContent = `âœ… å ´åœ°è³‡æ–™å·²æ›´æ–°`;
              document.body.appendChild(successMsg);
              
              setTimeout(() => {
                if (document.body.contains(successMsg)) {
                  document.body.removeChild(successMsg);
                }
              }, 2000);
              
            } else {
              document.body.removeChild(loadingMsg);
              alert('âŒ è¼‰å…¥å ´åœ°è³‡æ–™å¤±æ•—ï¼š' + data.msg);
            }
            } finally {
              // ğŸ†• ç¢ºä¿ç§»é™¤è«‹æ±‚æ¨™è¨˜ï¼ˆç„¡è«–æˆåŠŸæˆ–å¤±æ•—ï¼‰
              PENDING_REQUESTS.delete(requestKey);
            }
          } catch (err) {
            document.body.removeChild(loadingMsg);
            console.error('è¼‰å…¥å ´åœ°è³‡æ–™éŒ¯èª¤:', err);
            alert('âŒ è¼‰å…¥å ´åœ°è³‡æ–™å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
            // ğŸ†• ç¢ºä¿ç§»é™¤è«‹æ±‚æ¨™è¨˜
            PENDING_REQUESTS.delete(requestKey);
          }
        }
      });
      
      console.log('âœ… å ´åœ°é¸é …å·²æ›´æ–°ï¼Œå…±', freshVenueSelect.options.length - 1, 'å€‹å ´åœ°');
    }

    // æ›´æ–°å–é¤æ™‚é–“é¸é …
    function updateTimeOptions(hours, minutes) {
      const etaHour = document.getElementById('etaHour');
      const etaMinute = document.getElementById('etaMinute');
      
      // æ¸…ç©ºç¾æœ‰é¸é …ï¼ˆä¿ç•™ç¬¬ä¸€å€‹"æ™‚"/"åˆ†"ï¼‰
      etaHour.innerHTML = '<option value="">æ™‚</option>';
      etaMinute.innerHTML = '<option value="">åˆ†</option>';
      
      // æ·»åŠ å°æ™‚é¸é …
      hours.forEach(h => {
        const option = document.createElement('option');
        option.value = h;
        option.textContent = `${h} é»`;
        etaHour.appendChild(option);
      });
      
      // æ·»åŠ åˆ†é˜é¸é …
      minutes.forEach(m => {
        const option = document.createElement('option');
        option.value = m;
        option.textContent = `${m} åˆ†`;
        etaMinute.appendChild(option);
      });
      
      console.log('âœ… å–é¤æ™‚é–“é¸é …å·²æ›´æ–°');
    }

    // æ›´æ–°å–é¤æ–¹å¼é¸é …
    function updateMethodOptions(methods) {
      const methodSelect = document.querySelector('select[name="method"]');
      
      // æ¸…ç©ºç¾æœ‰é¸é …
      methodSelect.innerHTML = '';
      
      // æ·»åŠ æ–°é¸é …
      methods.forEach(method => {
        const option = document.createElement('option');
        option.value = method;
        // æ·»åŠ è¡¨æƒ…ç¬¦è™Ÿ
        const emoji = method.includes('è‡ªå–') ? 'ğŸš¶' : method.includes('ä»£å–') ? 'ğŸ‘¥' : method.includes('å¤–é€') ? 'ğŸ›µ' : 'ğŸ“¦';
        option.textContent = `${emoji} ${method}`;
        methodSelect.appendChild(option);
      });
      
      console.log('âœ… å–é¤æ–¹å¼é¸é …å·²æ›´æ–°');
    }

    // ====== æ›´æ–°å•†å“çš„ç¼ºè²¨ç‹€æ…‹å’Œåº«å­˜é¡¯ç¤º ======
    function updateStockStatus(forceUpdate = false) {
      // ğŸ”§ iOS ä¿®å¾©ï¼šä¿å­˜ç•¶å‰ç„¦é»å…ƒç´ å’Œæ»¾å‹•ä½ç½®
      const activeElement = document.activeElement;
      const scrollY = window.scrollY;
      const isInputFocused = activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'SELECT' || activeElement.tagName === 'TEXTAREA');
      
      // å¦‚æœç”¨æˆ·æ­£åœ¨è¾“å…¥ï¼Œè·³è¿‡æœ¬æ¬¡æ›´æ–°ï¼ˆé™¤éå¼ºåˆ¶æ›´æ–°ï¼‰
      if (isInputFocused && !forceUpdate) {
        if (window.DEBUG_MODE) console.log('â­ï¸ ç”¨æˆ·æ­£åœ¨è¾“å…¥ï¼Œè·³è¿‡æœ¬æ¬¡åº“å­˜æ›´æ–°');
        return;
      }
      
      // ğŸš€ æ€§èƒ½å„ªåŒ–ï¼šæ‰¹é‡æŸ¥è©¢ï¼Œæ¸›å°‘ DOM æ“ä½œ
      const cards = document.querySelectorAll('#products .product-card');
      if (cards.length === 0) return;
      
      // ä½¿ç”¨ requestAnimationFrame æ‰¹é‡æ›´æ–°ï¼Œæ¸›å°‘é‡æ’
      requestAnimationFrame(() => {
        cards.forEach(card => {
          const input = card.querySelector('input.qty');
          const itemName = input?.dataset.name;
          const stockEl = card.querySelector('.product-stock');
          
          if (itemName && INVENTORY[itemName]) {
            const stock = INVENTORY[itemName];
            const isOutOfStock = !stock.available || stock.stock <= 0;
            const hasBadge = card.querySelector('.out-of-stock-badge');
            
            // ğŸ”§ æ›´æ–°åº«å­˜é¡¯ç¤º
            if (stockEl) {
              const current = stock.stock || 0;
              const initial = stock.initialStock || 0;
              const stockColor = current === 0 ? 'var(--danger)' : (current <= initial * 0.3 ? 'var(--accent)' : 'var(--success)');
              const newHTML = `åº«å­˜ <span style="color:${stockColor}; font-weight:600;">(${current}/${initial})</span>`;
              // åªåœ¨å†…å®¹çœŸçš„æ”¹å˜æ—¶æ‰æ›´æ–°
              if (stockEl.innerHTML !== newHTML) {
                stockEl.innerHTML = newHTML;
              }
            }
            
            if (isOutOfStock) {
              // æ¨™è¨˜ç‚ºç¼ºè²¨
              card.classList.add('out-of-stock');
              
              // ç¦ç”¨è¼¸å…¥å’ŒæŒ‰éˆ•ï¼ˆæ‰¹é‡æ“ä½œï¼‰
              const inputs = card.querySelectorAll('input, button');
              inputs.forEach(el => el.disabled = true);
              
              // æ·»åŠ ç¼ºè²¨æ¨™ç±¤ï¼ˆå¦‚æœé‚„æ²’æœ‰ï¼‰
              if (!hasBadge) {
                const badge = document.createElement('div');
                badge.className = 'out-of-stock-badge';
                badge.textContent = 'ç¼ºè²¨ä¸­';
                card.insertBefore(badge, card.firstChild);
              }
            } else {
              // ç§»é™¤ç¼ºè²¨æ¨™è¨˜
              card.classList.remove('out-of-stock');
              const inputs = card.querySelectorAll('input, button');
              inputs.forEach(el => el.disabled = false);
              if (hasBadge) hasBadge.remove();
            }
          } else if (stockEl) {
            // å¦‚æœæ²’æœ‰åº«å­˜è³‡æ–™ï¼Œé¡¯ç¤ºæç¤º
            if (stockEl.innerHTML === 'è¼‰å…¥ä¸­...') {
              stockEl.innerHTML = '<span style="color:var(--muted);">åº«å­˜è¼‰å…¥ä¸­</span>';
            }
          }
        });
        
        // ğŸ”§ iOS ä¿®å¾©ï¼šæ¢å¾©æ»¾å‹•ä½ç½®ï¼ˆé˜²æ­¢é¡µé¢å¼¹å›ï¼‰
        if (window.scrollY !== scrollY) {
          window.scrollTo(0, scrollY);
        }
      });
    }

    // ====== ç”¢ç”Ÿå•†å“å¡ç‰‡ï¼ˆå‹•æ…‹ç”Ÿæˆï¼‰ ======
    const productsBox = document.querySelector('#products');
    
    // ç”Ÿæˆå•†å“åˆ—è¡¨
    function generateProducts(items) {
      // ğŸš€ æ€§èƒ½å„ªåŒ–ï¼šä½¿ç”¨ DocumentFragment æ‰¹é‡æ“ä½œï¼Œæ¸›å°‘é‡æ’
      const fragment = document.createDocumentFragment();
      
      // æ¸…ç©ºç¾æœ‰å•†å“åˆ—è¡¨
      productsBox.innerHTML = '';
      
      items.forEach(item => {
        const card = document.createElement('div');
        card.className = 'product-card';
        
        // ä½¿ç”¨ Sheet ä¸­çš„åœ–ç‰‡ç¶²å€ï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨é è¨­
        const imageUrl = item.imageUrl || item.img || 'https://images.unsplash.com/photo-1509440159596-0249088772ff?w=400&h=400&fit=crop&q=80';
        const basePrice = item.basePrice || 0;
        const priceRules = item.priceRules || [];
        const priceRuleText = item.priceRuleText || '';
        const hasDiscount = item.hasDiscount || false;
        const saleLabel = item.saleLabel || '';
        const recommendTag = item.recommendTag || '';
        const description = item.description || '';
        const dailyLimit = item.dailyLimit || 0;
        const minQty = item.minQty || 0; // ğŸ†• æœ€ä½è³¼è²·æ•¸é‡
        
        // ğŸ’° ç”Ÿæˆåƒ¹æ ¼é¡¯ç¤º HTMLï¼ˆé¡¯ç¤ºå–®åƒ¹ï¼‰
        let priceHTML = '';
        if (basePrice > 0) {
          // ğŸ”§ çµ±ä¸€é¡¯ç¤ºå–®åƒ¹ï¼Œä¸è«–æœ‰ç„¡å„ªæƒ éƒ½é¡¯ç¤ºåŸºç¤å–®åƒ¹
          if (hasDiscount && priceRules.length > 0) {
            // æœ‰å„ªæƒ ï¼šé¡¯ç¤ºã€Œå–®åƒ¹èµ·ã€ï¼ˆè¡¨ç¤ºæœ‰æ›´å„ªæƒ çš„æ–¹æ¡ˆï¼‰
            priceHTML = `<div style="font-size:clamp(14px,3vw,15px); font-weight:700; color:var(--primary);">$${basePrice}<span style="font-size:0.85em; font-weight:400; margin-left:2px;">èµ·</span></div>`;
          } else {
            // ç„¡å„ªæƒ ï¼šåªé¡¯ç¤ºå–®åƒ¹ï¼ˆä¸åŠ ã€Œèµ·ã€å­—ï¼‰
            priceHTML = `<div style="font-size:clamp(14px,3vw,15px); font-weight:700; color:var(--primary);">$${basePrice}</div>`;
          }
        } else {
          // åƒ¹æ ¼è¼‰å…¥ä¸­
          priceHTML = `<div style="font-size:clamp(13px,2.8vw,14px); color:var(--muted);">åƒ¹æ ¼è¼‰å…¥ä¸­</div>`;
        }
        
        // ğŸ·ï¸ å„ªæƒ æ¨™ç±¤ HTMLï¼ˆå¦‚æœæœ‰ï¼‰
        const saleLabelHTML = saleLabel ? `
          <div style="
            position:absolute; 
            top:6px; 
            left:6px; 
            background:linear-gradient(135deg, #dc2626 0%, #ef4444 100%); 
            color:#fff; 
            padding:clamp(3px,0.8vw,4px) clamp(6px,1.5vw,8px); 
            border-radius:clamp(4px,1vw,6px); 
            font-size:clamp(10px,2.2vw,11px); 
            font-weight:700; 
            z-index:5;
            box-shadow:0 2px 6px rgba(220,38,38,0.3);
          ">ğŸ·ï¸ ${saleLabel}</div>
        ` : '';
        
        // ğŸŒŸ æ¨è–¦æ¨™ç±¤ HTMLï¼ˆå¦‚æœæœ‰ï¼‰
        const tagColors = {
          'ç†±éŠ·': { bg: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)', emoji: 'ğŸ”¥', shadow: 'rgba(245,158,11,0.4)' },
          'æ–°å“': { bg: 'linear-gradient(135deg, #10b981 0%, #059669 100%)', emoji: 'âœ¨', shadow: 'rgba(16,185,129,0.4)' },
          'æ‹›ç‰Œ': { bg: 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)', emoji: 'ğŸ‘‘', shadow: 'rgba(139,92,246,0.4)' },
          'é™é‡': { bg: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)', emoji: 'â°', shadow: 'rgba(239,68,68,0.4)' },
          'æ¨è–¦': { bg: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)', emoji: 'â­', shadow: 'rgba(59,130,246,0.4)' }
        };
        
        let recommendTagHTML = '';
        if (recommendTag && tagColors[recommendTag]) {
          const tag = tagColors[recommendTag];
          recommendTagHTML = `
            <div style="
              position:absolute;
              top:6px;
              right:6px;
              background:${tag.bg};
              color:#fff;
              padding:clamp(3px,0.8vw,4px) clamp(6px,1.5vw,8px);
              border-radius:clamp(4px,1vw,6px);
              font-size:clamp(10px,2.2vw,11px);
              font-weight:700;
              z-index:10;
              box-shadow:0 2px 6px ${tag.shadow};
              animation:pulse 2s ease-in-out infinite;
            ">${tag.emoji} ${recommendTag}</div>
          `;
        }
        
        // ğŸ“ æ¯æ—¥é™é‡æç¤º HTMLï¼ˆå¦‚æœæœ‰ï¼‰
        const dailyLimitHTML = dailyLimit > 0 ? `
          <div style="
            font-size:clamp(10px,2.2vw,11px);
            color:#dc2626;
            font-weight:600;
            margin-top:clamp(2px,0.5vw,3px);
            display:flex;
            align-items:center;
            gap:4px;
          ">â° æ¯æ—¥é™é‡ ${dailyLimit} ä»½</div>
        ` : '';
        
        // ğŸ”¢ æœ€ä½è³¼è²·æ•¸é‡æç¤º HTMLï¼ˆå¦‚æœæœ‰ï¼‰
        const minQtyHTML = minQty > 0 ? `
          <div style="
            font-size:clamp(10px,2.2vw,11px);
            color:#059669;
            font-weight:600;
            margin-top:clamp(2px,0.5vw,3px);
            display:flex;
            align-items:center;
            gap:4px;
          ">ğŸ“¦ è‡³å°‘è³¼è²· ${minQty} å€‹</div>
        ` : '';
        
        card.innerHTML = `
          ${saleLabelHTML}
          ${recommendTagHTML}
          <div class="product-image-wrap" data-image="${imageUrl.replace('w=400&h=400', 'w=800&h=800')}" data-name="${item.name}" data-description="${description}">
            <img 
              src="${imageUrl}" 
              alt="${item.name}" 
              class="product-image" 
              loading="lazy"
              onerror="this.src='https://via.placeholder.com/400x400/fef3c7/b45309?text=${encodeURIComponent(item.name)}'"
            />
          </div>
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:clamp(5px,1.2vw,6px);">
            <div style="display:flex; flex-direction:column; gap:clamp(2px,0.5vw,3px); flex:1;">
              <div style="display:flex; align-items:center; gap:clamp(4px,1vw,6px);">
                <div class="product-name" style="margin-bottom:0;" title="${item.name}">${item.name}</div>
                <div class="product-stock" style="font-size:clamp(10px,2.2vw,11px); color:var(--muted); white-space:nowrap;">è¼‰å…¥ä¸­...</div>
              </div>
              ${dailyLimitHTML}
              ${minQtyHTML}
            </div>
            <div class="product-price" style="margin-bottom:0;">${priceHTML}</div>
          </div>
          ${priceRules.length > 0 ? `
            <select 
              class="price-plan-select" 
              data-name="${item.name}"
              style="
                width:100%;
                padding:clamp(6px,1.5vw,8px) clamp(8px,2vw,10px);
                border:1.5px solid var(--primary);
                border-radius:clamp(6px,1.5vw,8px);
                background:#fffbeb;
                font-size:clamp(12px,2.8vw,13px);
                font-weight:600;
                color:var(--text);
                margin-bottom:clamp(6px,1.5vw,8px);
                cursor:pointer;
              "
            >
              <option value="0">è«‹é¸æ“‡è³¼è²·æ–¹æ¡ˆ...</option>
              ${priceRules.map((rule, index) => {
                // ğŸ†• æ”¯æ´è‡ªè¨‚æ¨™ç±¤
                if (rule.isCustomLabel && rule.label) {
                  // è‡ªè¨‚æ¨™ç±¤æ ¼å¼ï¼šå¾æ¨™ç±¤ä¸­æå–æ•¸é‡ï¼Œé¡¯ç¤ºå¹³å‡åƒ¹
                  // ä¾‹å¦‚ï¼š"6å…¥è¢‹è£" â†’ æå– 6 â†’ è¨ˆç®— 100/6 = 16.7
                  const qtyMatch = rule.label.match(/(\d+)\s*å…¥/);
                  if (qtyMatch) {
                    const packageQty = parseInt(qtyMatch[1]); // åŒ…è£å…§çš„æ•¸é‡ï¼ˆä¾‹å¦‚ï¼š6å…¥ï¼‰
                    const avgPrice = (rule.price / packageQty).toFixed(1); // å¹³å‡æ¯å…¥åƒ¹æ ¼
                    return `<option value="${rule.qty}">${rule.label} $${rule.price} (å¹³å‡$${avgPrice})</option>`;
                  } else {
                    // æ¨™ç±¤ä¸­æ²’æœ‰"Xå…¥"ï¼Œå°±ä¸é¡¯ç¤ºå¹³å‡åƒ¹
                    return `<option value="${rule.qty}">${rule.label} $${rule.price}</option>`;
                  }
                } else {
                  // ä¸€èˆ¬æ ¼å¼ï¼š3å€‹ $200 (å¹³å‡$66) çœ$25
                  const avgPrice = Math.round(rule.price / rule.qty);
                  const savings = (basePrice * rule.qty) - rule.price;
                  const savingsText = savings > 0 ? ` çœ$${savings}` : '';
                  const isRecommend = index === priceRules.length - 1 && priceRules.length > 1;
                  return `<option value="${rule.qty}">${rule.qty}å€‹ $${rule.price} (å¹³å‡$${avgPrice})${savingsText}${isRecommend ? ' â­æ¨è–¦' : ''}</option>`;
                }
              }).join('')}
            </select>
          ` : ''}
          <div class="qty-control">
            <button type="button" class="qty-btn" data-action="decrease" data-target="${item.name}">âˆ’</button>
            <input 
              type="number" 
              min="0" 
              max="99"
              value="0" 
              data-base-price="${basePrice}"
              data-price-rules='${JSON.stringify(priceRules)}'
              data-name="${item.name}"
              data-combo-group="${item.comboGroupId || ''}"
              data-min-qty="${minQty}"
              class="qty"
            />
            <button type="button" class="qty-btn" data-action="increase" data-target="${item.name}">+</button>
          </div>
          <div class="tier-price-tip" data-item="${item.name}" style="font-size:clamp(10px,2.2vw,11px); color:#059669; font-weight:600; margin-top:4px; min-height:14px; text-align:center;"></div>
        `;
        fragment.appendChild(card);
      });
      
      // ğŸš€ ä¸€æ¬¡æ€§æ·»åŠ æ‰€æœ‰å¡ç‰‡ï¼Œæ¸›å°‘é‡æ’
      productsBox.appendChild(fragment);
      
    // ğŸš€ ä¸éœ€è¦é‡æ–°ç¶å®šäº‹ä»¶ï¼ˆä½¿ç”¨äº‹ä»¶å§”è¨—çµ±ä¸€è™•ç†ï¼‰
    // äº‹ä»¶å§”è¨—å·²åœ¨ä¸‹æ–¹è¨­ç½®ï¼Œé¿å…é‡è¤‡ç¶å®šé€ æˆè¨˜æ†¶é«”æ´©æ¼
    }
    
    // åˆæ¬¡è¼‰å…¥é¡¯ç¤ºæç¤ºï¼ˆä¸ä½¿ç”¨é è¨­å•†å“ï¼‰
    productsBox.innerHTML = `
      <div style="
        grid-column: 1 / -1;
        text-align: center;
        padding: clamp(40px, 10vw, 60px) clamp(20px, 5vw, 30px);
        color: var(--muted);
      ">
        <div style="font-size: clamp(48px, 12vw, 64px); margin-bottom: 16px;">ğŸ“</div>
        <div style="font-size: clamp(16px, 4vw, 18px); font-weight: 600; margin-bottom: 8px;">è«‹å…ˆé¸æ“‡å–é¤å ´åœ°</div>
        <div style="font-size: clamp(13px, 3vw, 14px);">é¸æ“‡å ´åœ°å¾Œå³å¯æŸ¥çœ‹å•†å“åˆ—è¡¨</div>
      </div>
    `;

    // ====== åœ–ç‰‡é»æ“Šæ”¾å¤§åŠŸèƒ½ ======
    const imageModal = document.getElementById('imageModal');
    const modalImage = document.getElementById('modalImage');
    
    // å“ç‰Œ Logo é»æ“Šæ”¾å¤§
    const brandLogo = document.getElementById('brandLogo');
    brandLogo.addEventListener('click', () => {
      modalImage.src = "https://images.unsplash.com/photo-1509440159596-0249088772ff?w=800&h=800&fit=crop&q=80";
      modalImage.alt = "å…­è’œåŒ…Â·é¤è»Š";
      imageModal.classList.add('active');
    });
    
    // å•†å“åœ–ç‰‡é»æ“Šæ”¾å¤§ï¼ˆäº‹ä»¶å§”æ´¾ï¼‰
    document.addEventListener('click', (e) => {
      const menuImageWrap = e.target.closest('.menu-image-wrap');
      const imageWrap = e.target.closest('.product-image-wrap');
      
      if (menuImageWrap) {
        // èœå–®åœ–ç‰‡é»æ“Šæ”¾å¤§
        const largeImage = menuImageWrap.dataset.image;
        const name = menuImageWrap.dataset.name;
        modalImage.src = largeImage;
        modalImage.alt = name;
        imageModal.classList.add('active');
      } else if (imageWrap) {
        const largeImage = imageWrap.dataset.image;
        const name = imageWrap.dataset.name;
        const description = imageWrap.dataset.description;
        
        // å¦‚æœæœ‰å•†å“æè¿°ï¼Œé¡¯ç¤ºæè¿°å°è©±æ¡†ï¼›å¦å‰‡æ”¾å¤§åœ–ç‰‡
        if (description && description.trim() !== '') {
          showProductDescription(name, largeImage, description);
        } else {
          modalImage.src = largeImage;
          modalImage.alt = name;
          imageModal.classList.add('active');
        }
      }
    });
    
    // ğŸ“ é¡¯ç¤ºå•†å“æè¿°å°è©±æ¡†
    function showProductDescription(name, imageUrl, description) {
      const descModal = document.createElement('div');
      descModal.style.cssText = `
        position:fixed;
        inset:0;
        background:rgba(0,0,0,0.8);
        z-index:9999;
        display:flex;
        align-items:center;
        justify-content:center;
        padding:20px;
        animation:fadeIn 0.2s ease;
      `;
      
      descModal.innerHTML = `
        <div style="
          background:#fff;
          border-radius:16px;
          max-width:500px;
          width:100%;
          overflow:hidden;
          animation:zoomIn 0.2s ease;
        ">
          <img src="${imageUrl}" alt="${name}" style="width:100%; height:200px; object-fit:cover;" />
          <div style="padding:20px;">
            <h3 style="margin:0 0 12px; font-size:20px; font-weight:700; color:var(--text);">${name}</h3>
            <p style="margin:0; font-size:15px; line-height:1.6; color:#4b5563;">${description}</p>
            <button 
              onclick="this.closest('[style*=fixed]').remove()"
              style="
                margin-top:16px;
                width:100%;
                padding:10px;
                background:var(--primary);
                color:#fff;
                border:none;
                border-radius:8px;
                font-size:15px;
                font-weight:700;
                cursor:pointer;
              "
            >é—œé–‰</button>
          </div>
        </div>
      `;
      
      // é»æ“ŠèƒŒæ™¯é—œé–‰
      descModal.addEventListener('click', (e) => {
        if (e.target === descModal) {
          descModal.remove();
        }
      });
      
      document.body.appendChild(descModal);
    }
    
    // é»æ“Šæ¨¡æ…‹æ¡†é—œé–‰
    imageModal.addEventListener('click', () => {
      imageModal.classList.remove('active');
    });

    // ====== å–é¤æ™‚é–“çµ„åˆ ======
    const etaHour = document.getElementById('etaHour');
    const etaMinute = document.getElementById('etaMinute');
    const etaCombined = document.getElementById('etaCombined');
    
    function updateEta() {
      const hour = etaHour.value;
      const minute = etaMinute.value;
      if (hour && minute) {
        etaCombined.value = `${hour}:${minute}`;
      } else {
        etaCombined.value = '';
      }
    }
    
    etaHour.addEventListener('change', updateEta);
    etaMinute.addEventListener('change', updateEta);

    // ====== ğŸš€ çµ±ä¸€äº‹ä»¶å§”è¨—ï¼ˆæ‰€æœ‰è¼¸å…¥æ¡†ï¼‰ ======
    // ç›£è½æ‰€æœ‰æ•¸é‡è¼¸å…¥è®ŠåŒ–ï¼ˆä½¿ç”¨äº‹ä»¶å§”è¨—ï¼Œé¿å…é‡è¤‡ç¶å®šï¼‰
    document.addEventListener('input', (e) => {
      if (e.target.classList.contains('qty')) {
        const input = e.target;
        let value = parseInt(input.value) || 0;
        const minQty = parseInt(input.dataset.minQty) || 0;
        
        // ğŸ”¢ å¦‚æœæœ‰æœ€ä½æ•¸é‡é™åˆ¶ï¼Œä¸”è¼¸å…¥çš„æ•¸é‡åœ¨ 1 åˆ° minQty ä¹‹é–“ï¼Œé¡¯ç¤ºè­¦å‘Š
        if (minQty > 0 && value > 0 && value < minQty) {
          // æ·»åŠ ç´…è‰²é‚Šæ¡†æç¤º
          input.style.borderColor = '#dc2626';
          
          // åœ¨å•†å“å¡ç‰‡ä¸Šé¡¯ç¤ºæç¤º
          const tipEl = document.querySelector(`.tier-price-tip[data-item="${input.dataset.name}"]`);
          if (tipEl) {
            tipEl.textContent = `âš ï¸ è‡³å°‘éœ€è³¼è²· ${minQty} å€‹`;
            tipEl.style.color = '#dc2626';
          }
        } else {
          // ç§»é™¤è­¦å‘Šæ¨£å¼
          input.style.borderColor = '';
          
          // æ¸…é™¤æç¤ºï¼ˆæœƒåœ¨ recalc ä¸­é‡æ–°ç”Ÿæˆå„ªæƒ æç¤ºï¼‰
          const tipEl = document.querySelector(`.tier-price-tip[data-item="${input.dataset.name}"]`);
          if (tipEl && value === 0) {
            tipEl.textContent = '';
          }
        }
        
        input.setAttribute('value', input.value);
        debouncedRecalc(); // ä½¿ç”¨é˜²æŠ–ç‰ˆæœ¬
      }
    });
    
    // ğŸ¯ ç›£è½æ–¹æ¡ˆé¸æ“‡å™¨è®ŠåŒ–
    document.addEventListener('change', (e) => {
      if (e.target.classList.contains('price-plan-select')) {
        const selectedQty = parseInt(e.target.value) || 0;
        const itemName = e.target.dataset.name;
        const input = document.querySelector(`input[data-name="${itemName}"]`);
        
        if (input && selectedQty > 0) {
          input.value = selectedQty;
          input.setAttribute('value', selectedQty);
          recalc(); // ç«‹å³è¨ˆç®—
        }
      }
    });
    
    // ====== æ•¸é‡å¢æ¸›æŒ‰éˆ•äº‹ä»¶ ======
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('.qty-btn');
      if (!btn) return;
      
      const action = btn.dataset.action;
      const targetName = btn.dataset.target;
      const input = document.querySelector(`input[data-name="${targetName}"]`);
      
      if (!input) return;
      
      let currentValue = parseInt(input.value) || 0;
      const minQty = parseInt(input.dataset.minQty) || 0;
      
      if (action === 'increase') {
        if (currentValue < 99) {
          // ğŸ”¢ å¦‚æœç•¶å‰æ˜¯ 0 ä¸”æœ‰æœ€ä½æ•¸é‡é™åˆ¶ï¼Œç›´æ¥è·³åˆ°æœ€ä½æ•¸é‡
          if (currentValue === 0 && minQty > 0) {
            currentValue = minQty;
          } else {
            currentValue++;
          }
        }
      } else if (action === 'decrease') {
        if (currentValue > 0) {
          currentValue--;
          // ğŸ”¢ å¦‚æœæ¸›å°‘å¾Œå°æ–¼æœ€ä½æ•¸é‡ï¼Œç›´æ¥æ­¸é›¶ï¼ˆä¸èƒ½åœåœ¨ä¸­é–“ï¼‰
          if (minQty > 0 && currentValue > 0 && currentValue < minQty) {
            currentValue = 0;
          }
        }
      }
      
      input.value = currentValue;
      input.setAttribute('value', currentValue);
      
      // æŒ‰éˆ•é»æ“Šç«‹å³è¨ˆç®—ï¼ˆä¸ä½¿ç”¨é˜²æŠ–ï¼‰
      recalc();
    });

    // ====== å³æ™‚è¨ˆç®—èˆ‡é è¦½ ======
    const previewEl = document.querySelector('#preview');
    const totalEl = document.querySelector('#totalAmt');
    const form = document.querySelector('#orderForm');
    const result = document.querySelector('#result');

    // ğŸš€ æ€§èƒ½å„ªåŒ–ï¼šç·©å­˜ priceRules è§£æçµæœ
    const priceRulesCache = new Map();
    const MAX_CACHE_SIZE = 100; // æœ€å¤§ç·©å­˜æ•¸é‡ï¼Œé˜²æ­¢å…§å­˜æ³„æ¼
    
    // ğŸš€ æ¸…ç†éå¤§çš„ç·©å­˜
    function cleanPriceRulesCache() {
      if (priceRulesCache.size > MAX_CACHE_SIZE) {
        // åˆªé™¤æœ€èˆŠçš„ 50% ç·©å­˜
        const entries = Array.from(priceRulesCache.entries());
        const toDelete = entries.slice(0, Math.floor(entries.length / 2));
        toDelete.forEach(([key]) => priceRulesCache.delete(key));
      }
    }

    // å®šç¾©å¯¦éš›çš„ recalc å‡½æ•¸ï¼ˆçµ„åˆå„ªæƒ ç‰ˆæœ¬ï¼‰
    // ğŸ”§ ç¢ºä¿é€™å€‹ç‰ˆæœ¬ä¸æœƒè¢« app.js è¦†è“‹ï¼ˆä½¿ç”¨ window.recalc ä¿å­˜ï¼‰
    window.recalc = function() {
      let items = [];
      let total = 0;

      // æ¯æ¬¡è¨ˆç®—æ™‚é‡æ–°ç²å–æ‰€æœ‰ .qty å…ƒç´ ï¼ˆæ”¯æ´å‹•æ…‹ç”Ÿæˆçš„å•†å“ï¼‰
      const qtyInputs = document.querySelectorAll('.qty');
      
      // ğŸ†• ç¬¬1æ­¥ï¼šæ”¶é›†æ‰€æœ‰é€‰ä¸­çš„å•†å“
      const selectedItems = [];
      qtyInputs.forEach(q => {
        const n = parseInt(q.value || '0', 10);
        if (n > 0) {
          // ğŸš€ æ€§èƒ½å„ªåŒ–ï¼šç·©å­˜ JSON.parse çµæœ
          const priceRulesKey = q.dataset.priceRules || '[]';
          let priceRules;
          if (priceRulesCache.has(priceRulesKey)) {
            priceRules = priceRulesCache.get(priceRulesKey);
          } else {
            priceRules = JSON.parse(priceRulesKey);
            priceRulesCache.set(priceRulesKey, priceRules);
            // å®šæœŸæ¸…ç†ç·©å­˜
            if (priceRulesCache.size > MAX_CACHE_SIZE) {
              cleanPriceRulesCache();
            }
          }
          
          selectedItems.push({
            name: q.dataset.name,
            qty: n,
            basePrice: parseFloat(q.dataset.basePrice) || 0,
            priceRules: priceRules,
            comboGroup: q.dataset.comboGroup || ''
          });
        }
      });
      
      // ğŸ†• ç¬¬2æ­¥ï¼šæŒ‰çµ„IDåˆ†çµ„ï¼ˆç”¨æ–¼çµ„åˆå„ªæƒ è¨ˆç®—ï¼‰
      const comboGroups = {};
      selectedItems.forEach(item => {
        if (item.comboGroup) {
          if (!comboGroups[item.comboGroup]) {
            comboGroups[item.comboGroup] = {
              items: [],
              totalQty: 0,
              basePrice: item.basePrice,
              priceRules: item.priceRules
            };
          }
          comboGroups[item.comboGroup].items.push(item);
          comboGroups[item.comboGroup].totalQty += item.qty;
        }
      });
      
      // ğŸ†• ç¬¬3æ­¥ï¼šè®¡ç®—æ¯ä¸ªå•†å“çš„ä»·æ ¼
      selectedItems.forEach(item => {
        let subtotal = 0;
        let avgPrice = item.basePrice;
        
        if (item.comboGroup && comboGroups[item.comboGroup]) {
          // ğŸ¯ çµ„åˆå„ªæƒ ï¼šä½¿ç”¨çµ„ç¸½æ•¸é‡è¨ˆç®—ï¼Œå†æŒ‰æ¯”ä¾‹åˆ†é…
          const group = comboGroups[item.comboGroup];
          const groupTotalPrice = calculateTierPrice(group.totalQty, group.basePrice, group.priceRules);
          
          // æŒ‰æ•¸é‡æ¯”ä¾‹åˆ†é…åƒ¹æ ¼
          subtotal = Math.round(groupTotalPrice * (item.qty / group.totalQty));
          avgPrice = Math.round(subtotal / item.qty);
        } else {
          // ğŸ§® ä¸€èˆ¬è¨ˆç®—ï¼šå–®ç¨è¨ˆç®—
          subtotal = calculateTierPrice(item.qty, item.basePrice, item.priceRules);
          avgPrice = item.qty > 0 ? Math.round(subtotal / item.qty) : item.basePrice;
        }
        
        total += subtotal;
        items.push({
          name: item.name,
          qty: item.qty,
          basePrice: item.basePrice,
          avgPrice: avgPrice,
          subtotal: subtotal,
          priceRules: item.priceRules,
          comboGroup: item.comboGroup
        });
        
        // ğŸŒŸ æ›´æ–°å„ªæƒ æç¤º
        const tipEl = document.querySelector(`.tier-price-tip[data-item="${item.name}"]`);
        if (tipEl) {
          if (item.comboGroup && comboGroups[item.comboGroup]) {
            // é¡¯ç¤ºçµ„åˆå„ªæƒ æç¤º
            const group = comboGroups[item.comboGroup];
            const tip = getTierPriceTip(group.totalQty, group.basePrice, group.priceRules);
            if (tip) {
              tipEl.textContent = `ğŸ çµ„åˆå„ªæƒ ï¼š${tip}`;
              tipEl.style.color = '#059669';
            } else {
              tipEl.textContent = '';
            }
          } else {
            const tip = getTierPriceTip(item.qty, item.basePrice, item.priceRules);
            tipEl.textContent = tip;
          }
        }
      });
      
      // æ¸…ç©ºæœªé€‰ä¸­å•†å“çš„æç¤º
      qtyInputs.forEach(q => {
        if (!q.value || q.value === '0') {
          const tipEl = document.querySelector(`.tier-price-tip[data-item="${q.dataset.name}"]`);
          if (tipEl) {
            tipEl.textContent = '';
          }
        }
      });

      if (items.length === 0) {
        previewEl.innerHTML = '<div class="preview-empty">å°šæœªé¸æ“‡å•†å“</div>';
      } else {
        previewEl.innerHTML = items.map(item => `
          <div class="preview-item">
            <strong>${item.name}</strong> Ã— ${item.qty}
            <span style="font-size:0.9em;color:var(--muted);">
              ${item.priceRules.length > 0 ? `(å¹³å‡@$${item.avgPrice})` : `@$${item.basePrice}`}
            </span>
            <span style="float:right;color:var(--primary)">$${item.subtotal}</span>
            ${item.comboGroup ? `<br/><small style="color:#059669;">ğŸ çµ„åˆå„ªæƒ </small>` : ''}
          </div>
        `).join('');
      }

      totalEl.textContent = `$${total}`;
      return {items, total};
    };

    // ğŸ”§ å°‡ recalc ä¹Ÿè³¦å€¼çµ¦å±€éƒ¨è®Šé‡ï¼ˆå…¼å®¹æ€§ï¼‰
    recalc = window.recalc;
    
    // ğŸ”§ ä¿å­˜åŸå§‹ recalc å‡½æ•¸ï¼Œé˜²æ­¢è¢« app.js è¦†è“‹
    const originalRecalc = window.recalc;
    
    // ğŸš€ å‰µå»ºé˜²æŠ–ç‰ˆæœ¬ï¼ˆè¼¸å…¥æ™‚å»¶è¿Ÿ100msåŸ·è¡Œï¼Œé¿å…é »ç¹è¨ˆç®—ï¼‰
    // æ€§èƒ½å„ªåŒ–ï¼šæ¸›å°‘é˜²æŠ–æ™‚é–“ï¼Œæå‡éŸ¿æ‡‰é€Ÿåº¦
    debouncedRecalc = debounce(recalc, 100);
    
    // ğŸ”§ ç›£è½ app.js åŠ è¼‰å®Œæˆï¼Œç¢ºä¿ recalc ä¸è¢«è¦†è“‹ï¼ˆä¿è­·å„ªæƒ åƒ¹æ ¼åŠŸèƒ½ï¼‰
    const protectRecalc = () => {
      if (window.recalc !== originalRecalc && typeof originalRecalc === 'function') {
        console.log('ğŸ”§ æ¢å¾© index.html çš„ recalc å‡½æ•¸ï¼ˆæ”¯æŒå„ªæƒ åƒ¹æ ¼å’Œçµ„åˆå„ªæƒ ï¼‰');
        window.recalc = originalRecalc;
        recalc = originalRecalc;
        debouncedRecalc = debounce(recalc, 150);
      }
    };
    
    // åœ¨ DOMContentLoaded å¾Œæª¢æŸ¥
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(protectRecalc, 200); // ç­‰å¾… app.js åŸ·è¡Œ
      });
    } else {
      setTimeout(protectRecalc, 200);
    }

    recalc();

    // ğŸš€ é›¢ç·š/åœ¨ç·šæª¢æ¸¬
    let isOnline = navigator.onLine;
    
    window.addEventListener('online', () => {
      isOnline = true;
      const onlineMsg = document.createElement('div');
      onlineMsg.style.cssText = 'position:fixed; top:20px; right:20px; background:#059669; color:#fff; padding:12px 20px; border-radius:8px; z-index:9999; font-size:14px; font-weight:600;';
      onlineMsg.textContent = 'âœ… ç¶²è·¯å·²é€£ç·š';
      document.body.appendChild(onlineMsg);
      setTimeout(() => {
        if (document.body.contains(onlineMsg)) {
          document.body.removeChild(onlineMsg);
        }
      }, 3000);
      console.log('âœ… ç¶²è·¯å·²é€£ç·š');
    });
    
    window.addEventListener('offline', () => {
      isOnline = false;
      const offlineMsg = document.createElement('div');
      offlineMsg.style.cssText = 'position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#dc2626; color:#fff; padding:12px 20px; border-radius:8px; z-index:9999; font-size:14px; font-weight:600; box-shadow:0 4px 12px rgba(220,38,38,0.3);';
      offlineMsg.textContent = 'âš ï¸ ç¶²è·¯å·²æ–·ç·šï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½ç„¡æ³•ä½¿ç”¨';
      document.body.appendChild(offlineMsg);
      console.warn('âš ï¸ ç¶²è·¯å·²æ–·ç·š');
    });

    // ====== è¨»å†Š Service Workerï¼ˆé›¢ç·šæ”¯æ´ï¼‰ ======
    // ğŸ”§ æª¢æŸ¥å”è­°ï¼šService Worker åªèƒ½åœ¨ HTTP/HTTPS ä¸‹å·¥ä½œ
    const isSecureContext = window.location.protocol === 'https:' || 
                           window.location.protocol === 'http:' ||
                           window.location.hostname === 'localhost' ||
                           window.location.hostname === '127.0.0.1';
    
    if ('serviceWorker' in navigator && isSecureContext) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then((registration) => {
            console.log('âœ… Service Worker è¨»å†ŠæˆåŠŸ:', registration.scope);
            
            // ç›£è½æ›´æ–°
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // æœ‰æ–°ç‰ˆæœ¬å¯ç”¨
                  console.log('ğŸ†• ç™¼ç¾æ–°ç‰ˆæœ¬');
                  showUpdateNotification();
                }
              });
            });
          })
          .catch((err) => {
            // ğŸ”§ åªåœ¨éé æœŸéŒ¯èª¤æ™‚é¡¯ç¤ºè­¦å‘Šï¼ˆé¿å…åœ¨æœ¬åœ°æ–‡ä»¶ç³»çµ±ä¸‹é¡¯ç¤ºéŒ¯èª¤ï¼‰
            if (window.location.protocol !== 'file:' && window.location.protocol !== 'null:') {
              console.warn('âš ï¸ Service Worker è¨»å†Šå¤±æ•—:', err);
            } else {
              console.log('â„¹ï¸ Service Worker åƒ…åœ¨ HTTP/HTTPS å”è­°ä¸‹å¯ç”¨ï¼ˆç•¶å‰ç‚ºæœ¬åœ°æ–‡ä»¶ï¼‰');
            }
          });
      });
      
      // ç›£è½ Service Worker è¨Šæ¯ï¼ˆåƒ…åœ¨å®‰å…¨ä¸Šä¸‹æ–‡ä¸­ï¼‰
      if (isSecureContext && navigator.serviceWorker.controller) {
        navigator.serviceWorker.addEventListener('message', (event) => {
          if (event.data && event.data.type === 'CACHE_CLEARED') {
            console.log('âœ… Service Worker å¿«å–å·²æ¸…é™¤');
          }
        });
      }
    }
    
    // ğŸ”” é¡¯ç¤ºæ›´æ–°é€šçŸ¥
    function showUpdateNotification() {
      const updateBanner = document.createElement('div');
      updateBanner.style.cssText = `
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: #fff;
        padding: 12px 20px;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
        z-index: 9999;
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 14px;
        font-weight: 600;
        animation: slideUp 0.3s ease;
      `;
      
      updateBanner.innerHTML = `
        <span>ğŸ†• æœ‰æ–°ç‰ˆæœ¬å¯ç”¨</span>
        <button 
          onclick="location.reload()" 
          style="
            padding: 6px 14px;
            background: #fff;
            color: #2563eb;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
          "
        >ç«‹å³æ›´æ–°</button>
      `;
      
      document.body.appendChild(updateBanner);
    }
    
    // ğŸ”§ é¡¯ç¤ºå¿«å–ç®¡ç†å°è©±æ¡†
    function showCacheManager() {
      const info = getCacheInfo();
      
      // è¨ˆç®— Service Worker å¿«å–å¤§å°ï¼ˆä¼°ç®—ï¼‰
      let swCacheSize = 'è¨ˆç®—ä¸­...';
      if ('storage' in navigator && 'estimate' in navigator.storage) {
        navigator.storage.estimate().then(estimate => {
          const usageInMB = (estimate.usage / (1024 * 1024)).toFixed(2);
          document.getElementById('swCacheSize').textContent = `${usageInMB} MB`;
        });
      }
      
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.7);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        animation: fadeIn 0.2s ease;
      `;
      
      modal.innerHTML = `
        <div style="
          background: #fff;
          border-radius: 16px;
          max-width: 500px;
          width: 100%;
          max-height: 80vh;
          overflow-y: auto;
          animation: zoomIn 0.2s ease;
        ">
          <!-- æ¨™é¡Œ -->
          <div style="
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
          ">
            <h2 style="margin: 0; font-size: 20px; font-weight: 700; color: var(--text);">
              âš™ï¸ å¿«å–ç®¡ç†
            </h2>
            <button 
              onclick="this.closest('[style*=fixed]').remove()"
              style="
                background: transparent;
                border: none;
                font-size: 24px;
                cursor: pointer;
                color: var(--muted);
                padding: 0;
                width: 32px;
                height: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
              "
            >Ã—</button>
          </div>
          
          <!-- å…§å®¹ -->
          <div style="padding: 20px;">
            <!-- å¿«å–çµ±è¨ˆ -->
            <div style="
              background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
              padding: 16px;
              border-radius: 12px;
              margin-bottom: 20px;
            ">
              <h3 style="margin: 0 0 12px; font-size: 16px; font-weight: 700; color: var(--text);">
                ğŸ“Š å¿«å–çµ±è¨ˆ
              </h3>
              <div style="display: grid; gap: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="color: var(--muted); font-size: 14px;">å ´åœ°å¿«å–æ•¸é‡</span>
                  <span style="font-weight: 700; color: var(--primary);">${info.cacheCount} å€‹</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="color: var(--muted); font-size: 14px;">å¿«å–å¤§å°</span>
                  <span style="font-weight: 700; color: var(--primary);">${info.cacheSizeKB} KB</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="color: var(--muted); font-size: 14px;">åœ–ç‰‡å¿«å–æ•¸é‡</span>
                  <span style="font-weight: 700; color: var(--primary);">${IMAGE_CACHE.size} å¼µ</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="color: var(--muted); font-size: 14px;">Service Worker</span>
                  <span style="font-weight: 700; color: ${('serviceWorker' in navigator && navigator.serviceWorker.controller) ? 'var(--success)' : 'var(--muted)'};">
                    ${('serviceWorker' in navigator && navigator.serviceWorker.controller) ? 'âœ… å·²å•Ÿç”¨' : (window.location.protocol === 'file:' || window.location.protocol === 'null:') ? 'âš ï¸ åƒ…åœ¨ HTTP/HTTPS å¯ç”¨' : 'âŒ æœªå•Ÿç”¨'}
                  </span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="color: var(--muted); font-size: 14px;">ç¸½å¿«å–å¤§å°</span>
                  <span id="swCacheSize" style="font-weight: 700; color: var(--primary);">${swCacheSize}</span>
                </div>
              </div>
            </div>
            
            <!-- å¿«å–èªªæ˜ -->
            <div style="
              background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
              padding: 16px;
              border-radius: 12px;
              margin-bottom: 20px;
              border: 1.5px solid #fbbf24;
            ">
              <h3 style="margin: 0 0 8px; font-size: 15px; font-weight: 700; color: #92400e;">
                ğŸ’¡ å¿«å–èªªæ˜
              </h3>
              <ul style="margin: 0; padding-left: 20px; color: #78350f; font-size: 13px; line-height: 1.8;">
                <li><strong>LocalStorage å¿«å–</strong>ï¼šå„²å­˜å ´åœ°è³‡æ–™ï¼Œ5åˆ†é˜æœ‰æ•ˆ</li>
                <li><strong>åœ–ç‰‡å¿«å–</strong>ï¼šé è¼‰å…¥å•†å“åœ–ç‰‡ï¼ŒåŠ å¿«é¡¯ç¤ºé€Ÿåº¦</li>
                <li><strong>Service Worker</strong>ï¼šé›¢ç·šæ™‚ä¹Ÿèƒ½æŸ¥çœ‹å·²è¼‰å…¥çš„å…§å®¹</li>
              </ul>
            </div>
            
            <!-- æ“ä½œæŒ‰éˆ• -->
            <div style="display: grid; gap: 10px;">
              <button 
                onclick="clearAllCache(); location.reload()"
                style="
                  width: 100%;
                  padding: 12px;
                  background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
                  color: #fff;
                  border: none;
                  border-radius: 10px;
                  font-size: 15px;
                  font-weight: 700;
                  cursor: pointer;
                  box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
                  transition: all .2s ease;
                "
                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(239, 68, 68, 0.4)'"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(239, 68, 68, 0.3)'"
              >
                ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰å¿«å–
              </button>
              
              ${('serviceWorker' in navigator && navigator.serviceWorker.controller) ? `
                <button 
                  onclick="if(navigator.serviceWorker.controller){navigator.serviceWorker.controller.postMessage({type: 'CLEAR_CACHE'}); setTimeout(() => location.reload(), 500)}"
                  style="
                    width: 100%;
                    padding: 12px;
                    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                    color: #fff;
                    border: none;
                    border-radius: 10px;
                    font-size: 15px;
                    font-weight: 700;
                    cursor: pointer;
                    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
                    transition: all .2s ease;
                  "
                  onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(245, 158, 11, 0.4)'"
                  onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(245, 158, 11, 0.3)'"
                >
                  ğŸ”„ æ¸…é™¤ Service Worker å¿«å–
                </button>
              ` : ''}
              
              <button 
                onclick="this.closest('[style*=fixed]').remove()"
                style="
                  width: 100%;
                  padding: 12px;
                  background: #fff;
                  color: var(--muted);
                  border: 1.5px solid var(--border);
                  border-radius: 10px;
                  font-size: 15px;
                  font-weight: 700;
                  cursor: pointer;
                  transition: all .2s ease;
                "
                onmouseover="this.style.borderColor='var(--muted)'"
                onmouseout="this.style.borderColor='var(--border)'"
              >
                é—œé–‰
              </button>
            </div>
          </div>
        </div>
      `;
      
      // é»æ“ŠèƒŒæ™¯é—œé–‰
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });
      
      document.body.appendChild(modal);
    }
    
    // ç¶å®šå¿«å–ç®¡ç†æŒ‰éˆ•
    document.addEventListener('click', (e) => {
      if (e.target.id === 'cacheManagerBtn' || e.target.closest('#cacheManagerBtn')) {
        showCacheManager();
      }
    });
    
    // ====== é é¢è¼‰å…¥æ™‚åˆå§‹åŒ– ======
    window.addEventListener('DOMContentLoaded', async () => {
      // ğŸ’¾ é¦–å…ˆå¾ LocalStorage æ¢å¾©å¿«å–ï¼ˆç«‹å³å¯ç”¨ï¼‰
      loadCacheFromStorage();
      
      // âš ï¸ å„ªå…ˆæª¢æŸ¥æˆæ¬Šï¼ˆå¦‚æœæœ‰å¤–éƒ¨ app.js å®šç¾©äº† checkAuthorizationï¼‰
      // ğŸ”§ æ³¨æ„ï¼šå¦‚æœ app.js å·²ç¶“è™•ç†äº†æˆæ¬Šæª¢æŸ¥å’Œè­¦å‘Šé¡¯ç¤ºï¼Œé€™è£¡å°±è·³é
      // å› ç‚º app.js æœƒåœ¨å®ƒçš„ DOMContentLoaded ä¸­è™•ç†ï¼Œé¿å…é‡è¤‡
      if (typeof checkAuthorization === 'function' && typeof window.__authChecked === 'undefined') {
        const authResult = await checkAuthorization();
        if (!authResult.authorized) {
          // å¦‚æœ app.js æœ‰ showLockScreenï¼Œä½¿ç”¨å®ƒï¼›å¦å‰‡ä½¿ç”¨ index.html çš„
          if (typeof showLockScreen === 'function') {
            showLockScreen(authResult);
          } else {
            showAuthExpiredPage(authResult);
          }
          return; // åœæ­¢åˆå§‹åŒ–
        }
        // ğŸ”§ åªåœ¨æ•¸æ“šå®Œæ•´ä¸”å°šæœªé¡¯ç¤ºæ™‚æ‰é¡¯ç¤ºè­¦å‘Š
        if (authResult.showWarning && 
            authResult.daysLeft && 
            authResult.daysLeft !== undefined &&
            authResult.expireDate && 
            authResult.expireDate !== undefined &&
            authResult.expireDate !== 'undefined' &&
            !window.expiryWarningShown) {
          showExpiryWarning(authResult.daysLeft, authResult.expireDate, authResult);
        }
        // æ¨™è¨˜å·²æª¢æŸ¥ï¼Œé¿å… app.js é‡è¤‡è™•ç†
        window.__authChecked = true;
      }
      
      // ğŸ”§ iOS ä¿®å¾©ï¼šé˜»æ­¢è‡ªå‹•æ»¾å‹•å’Œç„¦é»è·³å‹•
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      if (isIOS) {
        console.log('ğŸ åµæ¸¬åˆ° iOS è£ç½®ï¼Œå•Ÿç”¨ç©©å®šæ€§å„ªåŒ–');
        
        // é˜²æ­¢ iOS Safari è‡ªå‹•ç¸®æ”¾
        document.addEventListener('touchstart', function(e) {
          if (e.touches.length > 1) {
            e.preventDefault();
          }
        }, { passive: false });
        
        // é˜²æ­¢é›™æ“Šç¸®æ”¾
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(e) {
          const now = Date.now();
          if (now - lastTouchEnd <= 300) {
            e.preventDefault();
          }
          lastTouchEnd = now;
        }, false);
      }
      
      const loadingOverlay = document.getElementById('loadingOverlay');
      const progressFill = document.getElementById('loadingProgressFill');
      const progressPercent = document.getElementById('loadingProgressPercent');
      const progressStatus = document.getElementById('loadingProgressStatus');
      
      // ğŸš€ é€²åº¦æ¢æ›´æ–°å‡½æ•¸
      function updateProgress(percent, status) {
        if (progressFill) {
          progressFill.style.width = `${Math.min(100, Math.max(0, percent))}%`;
        }
        if (progressPercent) {
          progressPercent.textContent = `${Math.round(percent)}%`;
        }
        if (progressStatus) {
          progressStatus.textContent = status || 'è¼‰å…¥ä¸­...';
        }
      }
      
      // åˆå§‹é€²åº¦
      updateProgress(10, 'åˆå§‹åŒ–ä¸­...');
      
      try {
        // ğŸš€ æœ€é€Ÿå„ªåŒ–ï¼šæ‰€æœ‰è«‹æ±‚ä¸¦è¡ŒåŸ·è¡Œï¼ˆä¸äº’ç›¸ç­‰å¾…ï¼‰
        const startTime = Date.now();
        
        // æ›´æ–°é€²åº¦ï¼šé–‹å§‹è¼‰å…¥
        updateProgress(20, 'æª¢æŸ¥æˆæ¬Šä¸­...');
        
        // ğŸš€ æ€§èƒ½å„ªåŒ–ï¼šæ·»åŠ è¶…æ™‚ä¿è­·ï¼Œé¿å…é•·æ™‚é–“ç­‰å¾…
        // ä½¿ç”¨ Promise.allSettled ä¸¦è¿½è¹¤æ¯å€‹éšæ®µçš„é€²åº¦
        const authPromise = checkAuthorization().then(result => {
          updateProgress(35, 'æª¢æŸ¥æˆæ¬Šå®Œæˆ');
          setTimeout(() => updateProgress(40, 'è¼‰å…¥ç³»çµ±è¨­å®šä¸­...'), 100);
          return result;
        }).catch(err => {
          updateProgress(35, 'æª¢æŸ¥æˆæ¬Šå®Œæˆ');
          throw err;
        });
        
        const configPromise = loadConfig().then(result => {
          updateProgress(55, 'ç³»çµ±è¨­å®šè¼‰å…¥å®Œæˆ');
          setTimeout(() => updateProgress(60, 'è¼‰å…¥å•†å“è³‡æ–™ä¸­...'), 100);
          return result;
        }).catch(err => {
          updateProgress(55, 'ç³»çµ±è¨­å®šè¼‰å…¥å®Œæˆ');
          throw err;
        });
        
        const inventoryPromise = loadInventory().then(result => {
          updateProgress(75, 'å•†å“è³‡æ–™è¼‰å…¥å®Œæˆ');
          setTimeout(() => updateProgress(80, 'æº–å‚™å®Œæˆä¸­...'), 100);
          return result;
        }).catch(err => {
          updateProgress(75, 'å•†å“è³‡æ–™è¼‰å…¥å®Œæˆ');
          throw err;
        });
        
        const initPromise = Promise.allSettled([
          authPromise,
          configPromise,
          inventoryPromise
        ]);
        
        const timeoutPromise = new Promise((_, reject) => 
          setTimeout(() => reject(new Error('åˆå§‹åŒ–è¶…æ™‚ï¼ˆ30ç§’ï¼‰')), 30000)
        );
        
        let authResult, configResult, inventoryResult;
        try {
          [authResult, configResult, inventoryResult] = await Promise.race([
            initPromise,
            timeoutPromise.then(() => { throw new Error('è¶…æ™‚'); })
          ]);
          updateProgress(90, 'æœ€å¾Œæª¢æŸ¥ä¸­...');
        } catch (timeoutErr) {
          console.error('âŒ åˆå§‹åŒ–è¶…æ™‚:', timeoutErr);
          updateProgress(100, 'è¼‰å…¥å®Œæˆï¼ˆéƒ¨åˆ†åŠŸèƒ½å¯èƒ½å—é™ï¼‰');
          // è¶…æ™‚æ™‚ä½¿ç”¨é»˜èªå€¼
          authResult = { status: 'fulfilled', value: { authorized: true } };
          configResult = { status: 'rejected', reason: timeoutErr };
          inventoryResult = { status: 'rejected', reason: timeoutErr };
        }
        
        // æª¢æŸ¥æˆæ¬Šçµæœ
        if (authResult.status === 'fulfilled' && !authResult.value.authorized) {
          // æˆæ¬Šå¤±æ•ˆï¼Œé¡¯ç¤ºåˆ°æœŸé é¢
          updateProgress(100, 'æˆæ¬Šæª¢æŸ¥å®Œæˆ');
          loadingOverlay.classList.add('hidden');
          setTimeout(() => {
            showAuthExpiredPage(authResult.value);
          }, 300);
          return; // åœæ­¢è¼‰å…¥
        }
        
        // å¦‚æœæˆæ¬Šå³å°‡åˆ°æœŸï¼Œé¡¯ç¤ºè­¦å‘Šï¼ˆç¢ºä¿æ•¸æ“šå®Œæ•´ä¸”æœªé‡è¤‡é¡¯ç¤ºï¼‰
        if (authResult.status === 'fulfilled' && 
            authResult.value.showWarning && 
            authResult.value.daysLeft && 
            authResult.value.daysLeft !== undefined &&
            authResult.value.expireDate && 
            authResult.value.expireDate !== undefined &&
            authResult.value.expireDate !== 'undefined' &&
            !window.expiryWarningShown) {
          showExpiryWarning(authResult.value.daysLeft, authResult.value.expireDate, authResult.value);
        }
        
        // ğŸš€ æ€§èƒ½å„ªåŒ–ï¼šæ¸›å°‘æœ€å°é¡¯ç¤ºæ™‚é–“ï¼Œæå‡è¼‰å…¥é€Ÿåº¦
        const elapsedTime = Date.now() - startTime;
        const minDisplayTime = 1500; // è‡³å°‘é¡¯ç¤º 1.5 ç§’ï¼ˆå¾ 2.5 ç§’æ¸›å°‘ï¼‰
        
        // ç¢ºä¿é€²åº¦æ¢é¡¯ç¤ºåˆ° 100%
        updateProgress(100, 'è¼‰å…¥å®Œæˆï¼');
        
        if (elapsedTime < minDisplayTime) {
          await new Promise(resolve => setTimeout(resolve, minDisplayTime - elapsedTime));
        }
        
        if (window.DEBUG_MODE) console.log('âœ… ç³»çµ±åˆå§‹åŒ–å®Œæˆ');
      } catch (err) {
        console.error('âŒ åˆå§‹åŒ–æ™‚ç™¼ç”ŸéŒ¯èª¤:', err);
        updateProgress(100, 'è¼‰å…¥å®Œæˆï¼ˆéƒ¨åˆ†åŠŸèƒ½å¯èƒ½å—é™ï¼‰');
        // ğŸš€ éŒ¯èª¤è™•ç†ï¼šå³ä½¿åˆå§‹åŒ–å¤±æ•—ï¼Œä¹Ÿéš±è—è¼‰å…¥ç•«é¢
        setTimeout(() => {
          loadingOverlay.classList.add('hidden');
          setTimeout(() => {
            loadingOverlay.style.display = 'none';
          }, 300);
        }, 500);
        return; // æå‰è¿”å›ï¼Œä¸åŸ·è¡Œ finally ä¸­çš„éš±è—é‚è¼¯
      } finally {
        // ç¢ºä¿é€²åº¦æ¢å®Œæˆ
        updateProgress(100, 'è¼‰å…¥å®Œæˆï¼');
        
        // éš±è—è¼‰å…¥æç¤ºï¼ˆå»¶é²ä¸€é»è®“ç”¨æˆ¶çœ‹åˆ° 100%ï¼‰
        setTimeout(() => {
          loadingOverlay.classList.add('hidden');
          setTimeout(() => {
            loadingOverlay.style.display = 'none';
            
            // ğŸ¯ è¼‰å…¥å®Œæˆå¾Œè‡ªå‹•èšç„¦åˆ°å ´åœ°é¸æ“‡å™¨
            const venueSelect = document.getElementById('venueSelect');
            if (venueSelect) {
              // å»¶é²èšç„¦ï¼Œç¢ºä¿å‹•ç•«å®Œæˆ
              setTimeout(() => {
                venueSelect.focus();
                // å¯é¸ï¼šæ»¾å‹•åˆ°å ´åœ°é¸æ“‡å™¨ä½ç½®
                venueSelect.scrollIntoView({ behavior: 'smooth', block: 'center' });
                if (window.DEBUG_MODE) console.log('ğŸ¯ å·²è‡ªå‹•èšç„¦åˆ°å–é¤å ´åœ°é¸æ“‡å™¨');
              }, 100);
            }
          }, 300);
        }, 500);
      }
      
      // âœ… å·²ç§»é™¤è‡ªå‹•åˆ·æ–°åŠŸèƒ½
      // åŸå› ï¼šé é¢è¼‰å…¥æ™‚å·²æ˜¯æœ€æ–°æ•¸æ“šï¼Œè‡ªå‹•åˆ·æ–°æœƒé€ æˆ iOS å¼¹å›å•é¡Œä¸”ç„¡å¯¦éš›éœ€æ±‚
      // åªåœ¨ä»¥ä¸‹æƒ…æ³æœƒæ›´æ–°åº«å­˜ï¼š
      // 1. é é¢é¦–æ¬¡è¼‰å…¥
      // 2. ç”¨æˆ¶åˆ‡æ›å–é¤å ´åœ°
      console.log('âœ… åº«å­˜è¼‰å…¥å®Œæˆï¼Œä¸æœƒè‡ªå‹•åˆ·æ–°ï¼ˆé¿å…å¹²æ“¾ç”¨æˆ¶æ“ä½œï¼‰');
    });

    // ====== åˆ·æ–°å ´åœ°åº«å­˜æŒ‰éˆ• ======
    document.addEventListener('click', async (e) => {
      if (e.target.id === 'refreshVenueBtn') {
        e.preventDefault();
        
        if (!CURRENT_VENUE) {
          alert('âš ï¸ è«‹å…ˆé¸æ“‡å–é¤å ´åœ°');
          return;
        }
        
        // ğŸ†• æª¢æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒè«‹æ±‚æ­£åœ¨é€²è¡Œï¼ˆå»é‡ï¼Œé¿å…é‡è¤‡è«‹æ±‚å°è‡´ 503ï¼‰
        const requestKey = `inventory_${CURRENT_VENUE}`;
        if (PENDING_REQUESTS.has(requestKey)) {
          console.log(`â­ï¸ åˆ·æ–°è«‹æ±‚é€²è¡Œä¸­ï¼Œè«‹ç¨å€™...`);
          return;
        }
        
        // æ¸…é™¤è©²å ´åœ°çš„å¿«å–
        delete VENUE_CACHE[CURRENT_VENUE];
        console.log(`ğŸ—‘ï¸ å·²æ¸…é™¤å ´åœ°å¿«å–ï¼š${CURRENT_VENUE}`);
        
        // é¡¯ç¤ºè¼‰å…¥æç¤º
        const loadingMsg = document.createElement('div');
        loadingMsg.style.cssText = 'position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.8); color:#fff; padding:20px 40px; border-radius:10px; z-index:9999; font-size:16px; font-weight:600;';
        loadingMsg.textContent = 'ğŸ”„ åˆ·æ–°åº«å­˜ä¸­...';
        document.body.appendChild(loadingMsg);
        
        // æ¨™è¨˜è«‹æ±‚é€²è¡Œä¸­
        PENDING_REQUESTS.add(requestKey);
        
        try {
          // é‡æ–°å¾æœå‹™å™¨è¼‰å…¥
          const res = await fetch(`${GAS_ENDPOINT}?action=getInventory&venue=${CURRENT_VENUE}&_t=${Date.now()}`);
          const data = await res.json();
          
          if (data.ok) {
            INVENTORY = data.inventory;
            
            // ğŸ”„ å…¼å®¹è™•ç†ï¼šæ”¯æ´ products æˆ– mainItems
            let productsList = [];
            
            if (data.products && data.products.length > 0) {
              productsList = data.products;
            } else if (data.mainItems && data.mainItems.length > 0) {
              productsList = data.mainItems.map(item => {
                const invData = INVENTORY[item.name] || {};
                return {
                  name: item.name,
                  img: item.imageUrl || invData.imageUrl || item.img || '',
                  price: 0
                };
              });
            }
            
            if (productsList.length > 0) {
              PRODUCTS = productsList;
              generateProducts(PRODUCTS);
            }
            
            // æ›´æ–°åº«å­˜ç‹€æ…‹
            updateStockStatus(true); // å¼·åˆ¶æ›´æ–°ï¼ˆæ‰‹å‹•åˆ·æ–°ï¼‰
            
            // é‡æ–°å„²å­˜åˆ°å¿«å–
            VENUE_CACHE[CURRENT_VENUE] = {
              inventory: data.inventory,
              products: data.products,
              mainItems: data.mainItems,
              categories: data.categories,
              timestamp: Date.now()
            };
            
            // ğŸ’¾ åŒæ­¥åˆ° LocalStorage
            saveCacheToStorage();
            
            document.body.removeChild(loadingMsg);
            
            // é¡¯ç¤ºæˆåŠŸæç¤º
            const successMsg = document.createElement('div');
            successMsg.style.cssText = 'position:fixed; top:20px; right:20px; background:#059669; color:#fff; padding:12px 20px; border-radius:8px; z-index:9999; font-size:14px; font-weight:600;';
            successMsg.textContent = 'âœ… åº«å­˜å·²æ›´æ–°';
            document.body.appendChild(successMsg);
            
            setTimeout(() => {
              if (document.body.contains(successMsg)) {
                document.body.removeChild(successMsg);
              }
            }, 2000);
            
          } else {
            document.body.removeChild(loadingMsg);
            alert('âŒ åˆ·æ–°å¤±æ•—ï¼š' + data.msg);
          }
        } catch (err) {
          document.body.removeChild(loadingMsg);
          console.error('åˆ·æ–°åº«å­˜éŒ¯èª¤:', err);
          alert('âŒ åˆ·æ–°å¤±æ•—ï¼Œè«‹é‡è©¦');
        } finally {
          // ğŸ†• ç¢ºä¿ç§»é™¤è«‹æ±‚æ¨™è¨˜ï¼ˆç„¡è«–æˆåŠŸæˆ–å¤±æ•—ï¼‰
          PENDING_REQUESTS.delete(requestKey);
        }
      }
    });
    
    // ====== æ¸…ç©ºæŒ‰éˆ• ======
    document.querySelector('#resetBtn').addEventListener('click', () => {
      if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰é¸é …å—ï¼Ÿ')) {
        form.reset();
        // é‡ç½®æ™‚é–“é¸æ“‡
        etaHour.value = '';
        etaMinute.value = '';
        etaCombined.value = '';
        
        // é‡ç½®æ•¸é‡è¼¸å…¥ï¼ˆå¯¦æ™‚ç²å–ï¼ŒåŒ…å«å‹•æ…‹ç”Ÿæˆçš„ä¸»é¤å’Œé…èœï¼‰
        document.querySelectorAll('.qty').forEach(q => {
          q.value = 0;
          q.setAttribute('value', '0');
        });
        recalc();
        result.innerHTML = '';
      }
    });

    // ğŸš€ é˜²æ­¢é‡è¤‡æäº¤çš„æ¨™èªŒ
    let isSubmitting = false;
    
    // ====== è¡¨å–®é€å‡º ======
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // ğŸš€ é˜²æ­¢é‡è¤‡æäº¤
      if (isSubmitting) {
        console.log('â¸ï¸ è¨‚å–®æäº¤ä¸­ï¼Œè«‹å‹¿é‡è¤‡é»æ“Š');
        return;
      }
      
      const {items, total} = recalc();
      
      // é©—è­‰å ´åœ°ï¼ˆå¦‚æœæœ‰å ´åœ°é¸å–®ï¼‰
      const venueSelect = document.getElementById('venueSelect');
      if (venueSelect && !form.venue.value) {
        result.innerHTML = '<div class="message error">âš ï¸ è«‹é¸æ“‡å–é¤å ´åœ°</div>';
        venueSelect.focus();
        venueSelect.style.borderColor = '#dc2626';
        setTimeout(() => {
          venueSelect.style.borderColor = '';
        }, 2000);
        return;
      }
      
      // ğŸš€ é©—è­‰å§“åæ ¼å¼
      const nameValue = form.name.value.trim();
      if (!nameValue || nameValue.length < 2) {
        result.innerHTML = '<div class="message error">âš ï¸ è«‹è¼¸å…¥æœ‰æ•ˆçš„å§“åï¼ˆè‡³å°‘ 2 å€‹å­—ï¼‰</div>';
        form.name.focus();
        return;
      }
      
      // ğŸš€ é©—è­‰é›»è©±æ ¼å¼
      const phoneValue = form.phone.value.trim();
      if (!phoneValue || phoneValue.length < 3) {
        result.innerHTML = '<div class="message error">âš ï¸ è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»è©±è™Ÿç¢¼</div>';
        form.phone.focus();
        return;
      }
      
      // é©—è­‰æ™‚é–“
      if (!etaCombined.value) {
        result.innerHTML = '<div class="message error">âš ï¸ è«‹é¸æ“‡å–é¤æ™‚é–“</div>';
        return;
      }
      
      if (items.length === 0) {
        result.innerHTML = '<div class="message error">âš ï¸ è«‹è‡³å°‘é¸æ“‡ 1 é …å•†å“</div>';
        return;
      }
      
      // ğŸ”¢ æª¢æŸ¥æ˜¯å¦æœ‰é•åæœ€ä½è³¼è²·æ•¸é‡çš„å•†å“
      const invalidItems = [];
      document.querySelectorAll('.qty').forEach(q => {
        const qty = parseInt(q.value) || 0;
        const minQty = parseInt(q.dataset.minQty) || 0;
        const itemName = q.dataset.name;
        
        if (qty > 0 && minQty > 0 && qty < minQty) {
          invalidItems.push({ name: itemName, qty, minQty });
        }
      });
      
      if (invalidItems.length > 0) {
        const errorMsg = invalidItems.map(item => 
          `ã€${item.name}ã€‘è‡³å°‘éœ€è³¼è²· ${item.minQty} å€‹ï¼ˆç›®å‰ ${item.qty} å€‹ï¼‰`
        ).join('<br/>');
        
        result.innerHTML = `
          <div class="message error">
            âš ï¸ ä»¥ä¸‹å•†å“æœªé”æœ€ä½è³¼è²·æ•¸é‡ï¼š<br/>
            ${errorMsg}
          </div>
        `;
        result.scrollIntoView({behavior: 'smooth', block: 'center'});
        return;
      }
      
      // ğŸ†• æª¢æŸ¥æœ€ä½æ¶ˆè²»é‡‘é¡
      if (MIN_ORDER_AMOUNT > 0 && total < MIN_ORDER_AMOUNT) {
        result.innerHTML = `
          <div class="message error">
            âš ï¸ è¨‚å–®é‡‘é¡æœªé”æœ€ä½æ¶ˆè²»<br/>
            <strong>ç›®å‰é‡‘é¡ï¼š$${total}</strong><br/>
            <strong>æœ€ä½æ¶ˆè²»ï¼š$${MIN_ORDER_AMOUNT}</strong><br/>
            <small>è«‹å†åŠ è³¼ $${MIN_ORDER_AMOUNT - total} å³å¯é€å‡ºè¨‚å–®</small>
          </div>
        `;
        result.scrollIntoView({behavior: 'smooth', block: 'center'});
        return;
      }
      
      // ğŸš€ æ”¹é€²çš„ç¶²è·¯ç‹€æ…‹æª¢æŸ¥ï¼ˆä½¿ç”¨å¯¦éš›è«‹æ±‚é©—è­‰ï¼‰
      // æ³¨æ„ï¼šä¸ç›´æ¥ä¾è³´ navigator.onLineï¼Œå› ç‚ºå®ƒå¯èƒ½ä¸æº–ç¢º
      // æ”¹ç‚ºåœ¨å¯¦éš›æäº¤æ™‚è™•ç†ç¶²è·¯éŒ¯èª¤

      // ğŸ”§ ä½¿ç”¨æ¢è¡Œç¬¦åˆ†éš”ï¼Œåœ¨ Google Sheet ä¸­è‡ªåŠ¨æ¢è¡Œæ˜¾ç¤º
      const itemsDetail = items.map(it => `${it.name} x${it.qty}`).join('\n');

      // ç”Ÿæˆæ ¼å¼åŒ–è¨‚å–®æ‘˜è¦ï¼ˆç”¨æ–¼é¡¯ç¤ºå’Œå„²å­˜ï¼‰
      const nameParts = form.name.value.trim().split(/[\s\#]/);
      const mainName = nameParts[0] || '';
      const phone = form.phone.value.trim();
      const last3Digits = phone.slice(-3);
      const [hour, minute] = etaCombined.value.split(':');
      const timeStr = `${hour}é»${minute}åˆ†`;
      
      // å–å¾—å ´åœ°åç¨±
      let venueName = '';
      if (form.venue && form.venue.value) {
        const venueSelect = document.getElementById('venueSelect');
        const selectedOption = venueSelect.options[venueSelect.selectedIndex];
        venueName = selectedOption.textContent.replace('ğŸ“ ', '').trim();
      }
      
      // æ ¼å¼åŒ–é¤é»ï¼ˆæ¯è¡Œ3å€‹ï¼‰
      const itemLines = [];
      for (let i = 0; i < items.length; i += 3) {
        const lineItems = items.slice(i, i + 3).map(it => `${it.name} x${it.qty}`).join(' / ');
        itemLines.push(lineItems);
      }
      const itemsText = itemLines.join('\n');
      
      // çµ„åˆè¨‚å–®æ‘˜è¦ï¼ˆåŒ…å«å ´åœ°ï¼‰
      const orderSummary = `â‘  å§“å.å¾Œä¸‰ç¢¼ï¼š${mainName}.${last3Digits}
â‘¡ å–é¤å ´åœ°ï¼š${venueName || 'æœªæŒ‡å®š'}
â‘¢ æƒ³é è¨‚çš„æ™‚é–“ï¼š${timeStr}
â‘£ æƒ³é è¨‚çš„é¤é»ï¼š
${itemsText}
é‡‘é¡ï¼š${total}å…ƒ`;

      const payload = {
        ts: new Date().toISOString(),
        name: form.name.value.trim(),
        phone: form.phone.value.trim(),
        venue: form.venue ? form.venue.value : '', // å ´åœ°ä»£ç¢¼
        method: form.method.value,
        eta: etaCombined.value,
        itemsDetail,
        total,
        note: form.note.value.trim(),
        orderSummary: orderSummary,
        source: 'web'
      };

      try {
        // ğŸš€ è¨­ç½®æäº¤ä¸­ç‹€æ…‹ï¼Œç¦ç”¨é€å‡ºæŒ‰éˆ•
        isSubmitting = true;
        const submitBtn = form.querySelector('button[type="submit"]');
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.style.opacity = '0.5';
          submitBtn.style.cursor = 'not-allowed';
        }
        
        result.innerHTML = '<div class="message">â³ é€å‡ºä¸­ï¼Œè«‹ç¨å€™...</div>';
        
        // ä½¿ç”¨ FormData æ ¼å¼ï¼ˆGoogle Apps Script æ›´ç›¸å®¹ï¼‰
        const formData = new FormData();
        Object.keys(payload).forEach(key => {
          formData.append(key, payload[key]);
        });
        
        // ğŸš€ æ·»åŠ è¶…æ™‚æ©Ÿåˆ¶ï¼ˆ30ç§’ï¼‰
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000);
        
        let res;
        try {
          res = await fetch(GAS_ENDPOINT, {
            method: 'POST',
            body: formData,
            signal: controller.signal
          });
          clearTimeout(timeoutId);
        } catch (fetchErr) {
          clearTimeout(timeoutId);
          
          // å€åˆ†ä¸åŒé¡å‹çš„éŒ¯èª¤
          if (fetchErr.name === 'AbortError') {
            result.innerHTML = `
              <div class="message error">
                â±ï¸ è«‹æ±‚è¶…æ™‚ï¼ˆè¶…é30ç§’ï¼‰<br/>
                <small>è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šå¾Œé‡è©¦ï¼Œæˆ–è¯ç¹«ç®¡ç†å“¡</small>
              </div>
            `;
            result.scrollIntoView({behavior: 'smooth', block: 'center'});
            return;
          } else if (fetchErr.message && (
            fetchErr.message.includes('503') ||
            fetchErr.message.includes('Service Unavailable')
          )) {
            // ğŸ†• ç‰¹åˆ¥è™•ç† 503 éŒ¯èª¤
            result.innerHTML = `
              <div class="message error">
                âš ï¸ æœå‹™æš«æ™‚ä¸å¯ç”¨ï¼ˆ503 éŒ¯èª¤ï¼‰<br/>
                <small>å¯èƒ½åŸå› ï¼š<br/>
                1. Google Apps Script æœå‹™ç¹å¿™<br/>
                2. åŸ·è¡Œæ™‚é–“éé•·ï¼ˆè¶…é 6 åˆ†é˜ï¼‰<br/>
                3. æœå‹™å™¨æš«æ™‚éè¼‰</small><br/>
                <div style="margin-top: 12px; padding: 10px; background: #fffbeb; border: 1.5px solid #fbbf24; border-radius: 8px;">
                  <strong style="color: #92400e;">ğŸ’¡ å»ºè­°è™•ç†æ–¹å¼ï¼š</strong><br/>
                  <ol style="margin: 8px 0 0 20px; color: #78350f; font-size: 13px; line-height: 1.8;">
                    <li>ç­‰å¾… 30-60 ç§’å¾Œé‡æ–°æäº¤</li>
                    <li>æª¢æŸ¥ç¶²è·¯é€£ç·šæ˜¯å¦ç©©å®š</li>
                    <li>å¦‚æœæŒçºŒç™¼ç”Ÿï¼Œè«‹è¯ç¹«ç®¡ç†å“¡</li>
                  </ol>
                </div>
                <button 
                  type="button"
                  onclick="
                    const form = document.querySelector('#orderForm');
                    const submitBtn = form.querySelector('button[type=\"submit\"]');
                    if (submitBtn) {
                      submitBtn.disabled = false;
                      submitBtn.style.opacity = '1';
                      submitBtn.style.cursor = 'pointer';
                    }
                    this.closest('.message').remove();
                  "
                  style="
                    margin-top: 12px;
                    padding: 10px 20px;
                    background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-size: 14px;
                    font-weight: 700;
                    cursor: pointer;
                    box-shadow: 0 3px 10px rgba(217,119,6,.3);
                  "
                >ğŸ”„ ç¨å¾Œé‡è©¦</button>
              </div>
            `;
            result.scrollIntoView({behavior: 'smooth', block: 'center'});
            return;
          } else if (fetchErr.message && (
            fetchErr.message.includes('Failed to fetch') ||
            fetchErr.message.includes('NetworkError') ||
            fetchErr.message.includes('ç¶²è·¯') ||
            !navigator.onLine
          )) {
            result.innerHTML = `
              <div class="message error">
                ğŸŒ ç¶²è·¯é€£ç·šå¤±æ•—<br/>
                <small>è«‹æª¢æŸ¥ï¼š<br/>
                1. ç¶²è·¯é€£ç·šæ˜¯å¦æ­£å¸¸<br/>
                2. æ˜¯å¦å¯ä»¥ä½¿ç”¨å…¶ä»–ç¶²ç«™<br/>
                3. é˜²ç«ç‰†æˆ–ä»£ç†è¨­å®šæ˜¯å¦é˜»æ“‹</small><br/>
                <button 
                  type="button"
                  onclick="location.reload()"
                  style="
                    margin-top: 8px;
                    padding: 8px 16px;
                    background: var(--primary);
                    color: white;
                    border: none;
                    border-radius: 6px;
                    font-size: 13px;
                    font-weight: 600;
                    cursor: pointer;
                  "
                >ğŸ”„ é‡æ–°æ•´ç†å¾Œé‡è©¦</button>
              </div>
            `;
            result.scrollIntoView({behavior: 'smooth', block: 'center'});
            return;
          } else {
            throw fetchErr; // å…¶ä»–éŒ¯èª¤ç¹¼çºŒæ‹‹å‡º
          }
        }
        
        // æª¢æŸ¥ HTTP ç‹€æ…‹ç¢¼
        if (!res.ok) {
          // ğŸ†• ç‰¹åˆ¥è™•ç† 503 éŒ¯èª¤ï¼ˆæœå‹™æš«æ™‚ä¸å¯ç”¨ï¼‰
          if (res.status === 503) {
            result.innerHTML = `
              <div class="message error">
                âš ï¸ æœå‹™æš«æ™‚ä¸å¯ç”¨ï¼ˆ503 éŒ¯èª¤ï¼‰<br/>
                <small>å¯èƒ½åŸå› ï¼š<br/>
                1. Google Apps Script æœå‹™ç¹å¿™<br/>
                2. åŸ·è¡Œæ™‚é–“éé•·ï¼ˆè¶…é 6 åˆ†é˜ï¼‰<br/>
                3. æœå‹™å™¨æš«æ™‚éè¼‰</small><br/>
                <div style="margin-top: 12px; padding: 10px; background: #fffbeb; border: 1.5px solid #fbbf24; border-radius: 8px;">
                  <strong style="color: #92400e;">ğŸ’¡ å»ºè­°è™•ç†æ–¹å¼ï¼š</strong><br/>
                  <ol style="margin: 8px 0 0 20px; color: #78350f; font-size: 13px; line-height: 1.8;">
                    <li>ç­‰å¾… 30-60 ç§’å¾Œé‡æ–°æäº¤</li>
                    <li>æª¢æŸ¥ç¶²è·¯é€£ç·šæ˜¯å¦ç©©å®š</li>
                    <li>å¦‚æœæŒçºŒç™¼ç”Ÿï¼Œè«‹è¯ç¹«ç®¡ç†å“¡</li>
                  </ol>
                </div>
                <button 
                  type="button"
                  onclick="
                    const form = document.querySelector('#orderForm');
                    const submitBtn = form.querySelector('button[type=\"submit\"]');
                    if (submitBtn) {
                      submitBtn.disabled = false;
                      submitBtn.style.opacity = '1';
                      submitBtn.style.cursor = 'pointer';
                    }
                    this.closest('.message').remove();
                  "
                  style="
                    margin-top: 12px;
                    padding: 10px 20px;
                    background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-size: 14px;
                    font-weight: 700;
                    cursor: pointer;
                    box-shadow: 0 3px 10px rgba(217,119,6,.3);
                  "
                >ğŸ”„ ç¨å¾Œé‡è©¦</button>
              </div>
            `;
            result.scrollIntoView({behavior: 'smooth', block: 'center'});
            return;
          }
          // å…¶ä»– HTTP éŒ¯èª¤
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        const data = await res.json();
        
        if (data.ok) {
          // ä½¿ç”¨å·²ç”Ÿæˆçš„ orderSummary
          result.innerHTML = `
            <div class="message success">
              âœ… è¨‚å–®å·²é€å‡ºï¼<br/>
              <strong>è¨‚å–®ç·¨è™Ÿï¼š${data.orderNo}</strong><br/>
              <small>è«‹æº–æ™‚æ–¼ä»Šæ—¥ ${etaCombined.value} å–é¤</small>
            </div>
            <div style="
              margin-top: 12px;
              padding: 14px;
              background: #f9fafb;
              border: 1.5px solid var(--border);
              border-radius: clamp(8px, 2vw, 10px);
              font-size: clamp(12px, 3vw, 13px);
              line-height: 1.8;
              white-space: pre-line;
              font-family: monospace;
              position: relative;
            ">
              <div style="
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 12px;
                padding-bottom: 8px;
                border-bottom: 1px solid var(--border);
              ">
                <span style="
                  font-weight: 600;
                  color: var(--text);
                  font-size: clamp(13px, 3.2vw, 14px);
                  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                ">æ‚¨æ­¤æ¬¡çš„è¨‚å–®å¦‚ä¸‹</span>
                <button 
                  type="button"
                  onclick="navigator.clipboard.writeText(this.parentElement.nextElementSibling.textContent); this.textContent='âœ“ å·²è¤‡è£½'; setTimeout(()=>this.textContent='ğŸ“‹ è¤‡è£½è¨‚å–®', 2000)"
                  style="
                    padding: 4px 10px;
                    background: var(--primary);
                    color: white;
                    border: none;
                    border-radius: 6px;
                    font-size: clamp(10px, 2.5vw, 11px);
                    cursor: pointer;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    white-space: nowrap;
                  "
                >ğŸ“‹ è¤‡è£½è¨‚å–®</button>
              </div>
              <div>${orderSummary}</div>
            </div>
          `;
          // å¯é¸ï¼šè‡ªå‹•æ»¾å‹•åˆ°è¨Šæ¯ä½ç½®
          result.scrollIntoView({behavior: 'smooth', block: 'center'});
        } else {
          // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
          result.innerHTML = `<div class="message error">âŒ é€å‡ºå¤±æ•—ï¼š${data.msg || 'æœªçŸ¥éŒ¯èª¤'}</div>`;
          
          // å¦‚æœæ˜¯åº«å­˜ä¸è¶³éŒ¯èª¤ï¼Œè‡ªå‹•å°‡è©²å•†å“æ•¸é‡æ­¸é›¶
          if (data.msg && data.msg.includes('åº«å­˜ä¸è¶³')) {
            // æå–å•†å“åç¨±ï¼ˆä¾‹å¦‚ï¼šã€ç¶ è‹¦ç“œã€‘ï¼‰
            const match = data.msg.match(/ã€(.+?)ã€‘/);
            if (match) {
              const itemName = match[1];
              // æ‰¾åˆ°è©²å•†å“çš„è¼¸å…¥æ¡†ä¸¦æ­¸é›¶
              const input = document.querySelector(`input[data-name="${itemName}"]`);
              if (input) {
                input.value = 0;
                input.setAttribute('value', '0');
                // é‡æ–°è¨ˆç®—ç¸½é‡‘é¡
                recalc();
                // åœ¨éŒ¯èª¤è¨Šæ¯ä¸­æ·»åŠ æç¤º
                result.innerHTML += `<div class="message" style="margin-top:8px; background:#fffbeb; color:var(--accent); border-color:var(--accent);">ğŸ’¡ å·²è‡ªå‹•å°‡ã€Œ${itemName}ã€æ•¸é‡æ­¸é›¶ï¼Œè«‹é‡æ–°èª¿æ•´è¨‚å–®</div>`;
              }
            }
          }
          
          // æ»¾å‹•åˆ°éŒ¯èª¤è¨Šæ¯
          result.scrollIntoView({behavior: 'smooth', block: 'center'});
        }
      } catch (err) {
        console.error('è©³ç´°éŒ¯èª¤:', err);
        
        // æ ¹æ“šéŒ¯èª¤é¡å‹é¡¯ç¤ºä¸åŒçš„è¨Šæ¯
        let errorMsg = '';
        
        // ğŸ†• ç‰¹åˆ¥è™•ç† 503 éŒ¯èª¤
        if (err.message && (
          err.message.includes('503') ||
          err.message.includes('Service Unavailable') ||
          err.message.includes('æš«æ™‚ä¸å¯ç”¨')
        )) {
          errorMsg = `
            <div class="message error">
              âš ï¸ æœå‹™æš«æ™‚ä¸å¯ç”¨ï¼ˆ503 éŒ¯èª¤ï¼‰<br/>
              <small>å¯èƒ½åŸå› ï¼š<br/>
              1. Google Apps Script æœå‹™ç¹å¿™<br/>
              2. åŸ·è¡Œæ™‚é–“éé•·ï¼ˆè¶…é 6 åˆ†é˜ï¼‰<br/>
              3. æœå‹™å™¨æš«æ™‚éè¼‰</small><br/>
              <div style="margin-top: 12px; padding: 10px; background: #fffbeb; border: 1.5px solid #fbbf24; border-radius: 8px;">
                <strong style="color: #92400e;">ğŸ’¡ å»ºè­°è™•ç†æ–¹å¼ï¼š</strong><br/>
                <ol style="margin: 8px 0 0 20px; color: #78350f; font-size: 13px; line-height: 1.8;">
                  <li>ç­‰å¾… 30-60 ç§’å¾Œé‡æ–°æäº¤</li>
                  <li>æª¢æŸ¥ç¶²è·¯é€£ç·šæ˜¯å¦ç©©å®š</li>
                  <li>å¦‚æœæŒçºŒç™¼ç”Ÿï¼Œè«‹è¯ç¹«ç®¡ç†å“¡</li>
                </ol>
              </div>
              <button 
                type="button"
                onclick="
                  const form = document.querySelector('#orderForm');
                  const submitBtn = form.querySelector('button[type=\"submit\"]');
                  if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.style.opacity = '1';
                    submitBtn.style.cursor = 'pointer';
                  }
                  this.closest('.message').remove();
                "
                style="
                  margin-top: 12px;
                  padding: 10px 20px;
                  background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
                  color: white;
                  border: none;
                  border-radius: 8px;
                  font-size: 14px;
                  font-weight: 700;
                  cursor: pointer;
                  box-shadow: 0 3px 10px rgba(217,119,6,.3);
                "
              >ğŸ”„ ç¨å¾Œé‡è©¦</button>
            </div>
          `;
        } else if (err.name === 'AbortError' || err.message.includes('timeout')) {
          errorMsg = `
            <div class="message error">
              â±ï¸ è«‹æ±‚è¶…æ™‚<br/>
              <small>ä¼ºæœå™¨å›æ‡‰æ™‚é–“éé•·ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–è¯ç¹«ç®¡ç†å“¡</small>
            </div>
          `;
        } else if (err.message && (
          err.message.includes('Failed to fetch') ||
          err.message.includes('NetworkError') ||
          err.message.includes('ç¶²è·¯') ||
          err.message.includes('network')
        )) {
          errorMsg = `
            <div class="message error">
              ğŸŒ ç¶²è·¯é€£ç·šå¤±æ•—<br/>
              <small>ç„¡æ³•é€£æ¥åˆ°ä¼ºæœå™¨ï¼Œè«‹æª¢æŸ¥ï¼š<br/>
              1. ç¶²è·¯é€£ç·šæ˜¯å¦æ­£å¸¸<br/>
              2. æ˜¯å¦å¯ä»¥ä½¿ç”¨å…¶ä»–ç¶²ç«™<br/>
              3. é˜²ç«ç‰†æˆ–ä»£ç†è¨­å®š</small><br/>
              <button 
                type="button"
                onclick="location.reload()"
                style="
                  margin-top: 8px;
                  padding: 8px 16px;
                  background: var(--primary);
                  color: white;
                  border: none;
                  border-radius: 6px;
                  font-size: 13px;
                  font-weight: 600;
                  cursor: pointer;
                "
              >ğŸ”„ é‡æ–°æ•´ç†å¾Œé‡è©¦</button>
            </div>
          `;
        } else {
          errorMsg = `
            <div class="message error">
              âŒ é€å‡ºå¤±æ•—ï¼š${err.message || 'æœªçŸ¥éŒ¯èª¤'}<br/>
              <small>è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–è¯ç¹«ç®¡ç†å“¡</small>
            </div>
          `;
        }
        
        result.innerHTML = errorMsg;
        result.scrollIntoView({behavior: 'smooth', block: 'center'});
      } finally {
        // ğŸš€ é‡ç½®æäº¤ç‹€æ…‹ï¼Œæ¢å¾©é€å‡ºæŒ‰éˆ•
        isSubmitting = false;
        const submitBtn = form.querySelector('button[type="submit"]');
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.style.opacity = '1';
          submitBtn.style.cursor = 'pointer';
        }
      }
    });
  </script>

  <!-- åº•éƒ¨ç‰ˆæ¬Šä¿¡æ¯ -->
  <footer class="footer">
    <div>
      ç³»çµ±é–‹ç™¼ï¼š<a href="https://lin.ee/YyXagFg" target="_blank" rel="noopener noreferrer">å¿«é–ƒé¤è»Šå°å¹«æ‰‹</a> Â© 2025
    </div>
    <div class="footer-warning">
      âš ï¸ æœ¬ç³»çµ±å—è‘—ä½œæ¬Šæ³•ä¿è­·ï¼Œæœªç¶“æˆæ¬Šä¸å¾—è¤‡è£½ã€ä¿®æ”¹æˆ–ç”¨æ–¼å•†æ¥­ç”¨é€”
    </div>
  </footer>

  <!-- âš ï¸ é—œéµï¼šè¼‰å…¥å¤–éƒ¨ config.js å’Œ app.js ä»¥å•Ÿç”¨æˆæ¬Šæª¢æŸ¥ -->
  <!-- ğŸš€ æ€§èƒ½å„ªåŒ–ï¼šä½¿ç”¨ defer å»¶é²åŸ·è¡Œï¼Œä¸é˜»å¡ HTML è§£æ -->
  <script src="config.js" defer></script>
  <script src="app.js" defer></script>
</body>
</html>
